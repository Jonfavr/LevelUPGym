<!-- templates/admin/dashboard.html -->
{% extends "admin/base.html" %}

{% block title %}Dashboard ‚Äî LevelUp Gym Admin{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* ‚îÄ‚îÄ Occupancy bar ‚îÄ‚îÄ */
    .occupancy-bar-track {
        height: 6px;
        background: var(--bg-hover);
        border-radius: 3px;
        margin-top: 8px;
        overflow: hidden;
    }
    .occupancy-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--emerald));
        border-radius: 3px;
        transition: width 0.8s ease;
    }

    /* ‚îÄ‚îÄ Live client row ‚îÄ‚îÄ */
    .live-client {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
    }
    .live-client:last-child { border-bottom: none; }

    .live-avatar {
        width: 36px; height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        display: flex; align-items: center; justify-content: center;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        font-size: 14px;
        color: white;
        flex-shrink: 0;
    }

    .live-client-info { flex: 1; min-width: 0; }
    .live-client-name {
        font-size: 13.5px;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .live-client-meta { font-size: 11.5px; color: var(--text-muted); margin-top: 1px; }

    .live-dot {
        width: 8px; height: 8px;
        border-radius: 50%;
        background: var(--emerald);
        box-shadow: 0 0 6px var(--emerald);
        flex-shrink: 0;
        animation: pulse-dot 2s infinite;
    }
    .live-dot.out { background: var(--text-muted); box-shadow: none; animation: none; }

    /* ‚îÄ‚îÄ Quick action buttons ‚îÄ‚îÄ */
    .quick-action-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .quick-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 16px 10px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        text-decoration: none;
        color: var(--text-secondary);
        font-size: 12px;
        font-weight: 500;
        text-align: center;
        transition: all 0.2s;
    }

    .quick-action:hover {
        border-color: var(--border-accent);
        color: var(--accent);
        background: var(--bg-hover);
        transform: translateY(-2px);
    }

    .quick-action i {
        font-size: 20px;
    }

    .quick-action.accent i { color: var(--accent); }
    .quick-action.emerald i { color: var(--emerald); }
    .quick-action.amber i   { color: var(--amber); }
    .quick-action.red i     { color: var(--red); }

    /* ‚îÄ‚îÄ Top performers ‚îÄ‚îÄ */
    .performer-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
    }
    .performer-row:last-child { border-bottom: none; }

    .performer-rank-num {
        width: 22px;
        text-align: center;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        font-size: 14px;
        color: var(--text-muted);
        flex-shrink: 0;
    }
    .performer-rank-num.gold   { color: var(--amber); }
    .performer-rank-num.silver { color: #9ca3af; }
    .performer-rank-num.bronze { color: #b45309; }

    .performer-name {
        flex: 1;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
    }

    .performer-value {
        font-family: 'Rajdhani', sans-serif;
        font-size: 15px;
        font-weight: 700;
        color: var(--accent);
    }

    /* ‚îÄ‚îÄ Activity feed ‚îÄ‚îÄ */
    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
    }
    .activity-item:last-child { border-bottom: none; }

    .activity-icon {
        width: 30px; height: 30px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 12px;
        flex-shrink: 0;
        margin-top: 1px;
    }
    .activity-icon.checkin  { background: var(--emerald-glow); color: var(--emerald); }
    .activity-icon.exp      { background: var(--accent-glow); color: var(--accent); }
    .activity-icon.sale     { background: var(--amber-glow); color: var(--amber); }

    .activity-text  { font-size: 12.5px; color: var(--text-secondary); flex: 1; line-height: 1.5; }
    .activity-text strong { color: var(--text-primary); font-weight: 600; }
    .activity-time  { font-size: 11px; color: var(--text-muted); white-space: nowrap; margin-top: 3px; }

    /* ‚îÄ‚îÄ System info card ‚îÄ‚îÄ */
    .sys-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
    }
    .sys-row:last-child { border-bottom: none; }
    .sys-row .sys-label { color: var(--text-muted); }
    .sys-row .sys-val   { color: var(--text-primary); font-weight: 500; }

</style>
{% endblock %}

{% block content %}

<!-- ‚îÄ‚îÄ KPI Row ‚îÄ‚îÄ -->
<div class="grid grid-4" style="margin-bottom:24px;">
    <div class="stat-card accent">
        <div class="stat-icon accent"><i class="fa-solid fa-users"></i></div>
        <div class="stat-value">{{ total_clients }}</div>
        <div class="stat-label">Active Clients</div>
    </div>

    <div class="stat-card emerald">
        <div class="stat-icon emerald"><i class="fa-solid fa-door-open"></i></div>
        <div class="stat-value">{{ todays_attendance }}</div>
        <div class="stat-label">Today's Check-ins</div>
    </div>

    <div class="stat-card amber">
        <div class="stat-icon amber"><i class="fa-solid fa-calendar-week"></i></div>
        <div class="stat-value">{{ weekly_visits }}</div>
        <div class="stat-label">Weekly Visits</div>
    </div>

    <div class="stat-card red">
        <div class="stat-icon red"><i class="fa-solid fa-id-card-clip"></i></div>
        <div class="stat-value">{{ expiring_soon | default(0) }}</div>
        <div class="stat-label">Expiring Soon</div>
    </div>
</div>

<!-- ‚îÄ‚îÄ Main grid ‚îÄ‚îÄ -->
<div class="grid" style="grid-template-columns: 1fr 340px; gap: 20px; margin-bottom: 20px;">

    <!-- LEFT: Today's Attendance Table -->
    <div class="card" style="margin-bottom:0;">
        <div class="card-header">
            <div>
                <div class="card-title">
                    <span class="card-title-icon">üìã</span> Today's Attendance
                </div>
                <div class="section-subtitle">All check-ins for {{ today_date | default('today') }}</div>
            </div>
            <a href="{{ url_for('admin_attendance') }}" class="btn btn-ghost btn-sm">
                <i class="fa-solid fa-arrow-right"></i> Manage
            </a>
        </div>

        {% if attendance_list %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Check-in</th>
                        <th>Status</th>
                        <th>EXP</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance_list %}
                    <tr>
                        <td>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="live-avatar" style="width:30px;height:30px;font-size:12px;">
                                    {{ record.client_name[0] | upper if record.client_name else '?' }}
                                </div>
                                <div>
                                    <strong>{{ record.client_name }}</strong>
                                    <div style="font-size:11px; color:var(--text-muted);">{{ record.phone_number }}</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size:12.5px;">{{ record.check_in_time }}</td>
                        <td>
                            {% if record.check_out_time %}
                                <span class="badge badge-muted"><i class="fa-solid fa-circle" style="font-size:6px;"></i> Left</span>
                            {% else %}
                                <span class="badge badge-emerald"><i class="fa-solid fa-circle" style="font-size:6px;"></i> In Gym</span>
                            {% endif %}
                        </td>
                        <td>
                            <span style="color: var(--accent); font-family:'Rajdhani',sans-serif; font-weight:700; font-size:15px;">
                                +{{ record.exp_earned }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fa-solid fa-person-walking-arrow-right"></i>
            <p>No check-ins yet today.</p>
        </div>
        {% endif %}
    </div>

    <!-- RIGHT COLUMN -->
    <div style="display:flex; flex-direction:column; gap:20px;">

        <!-- Quick Actions -->
        <div class="card" style="margin-bottom:0;">
            <div class="card-title" style="margin-bottom:14px;">
                <span class="card-title-icon">‚ö°</span> Quick Actions
            </div>
            <div class="quick-action-grid">
                <a href="{{ url_for('admin_attendance') }}" class="quick-action emerald">
                    <i class="fa-solid fa-right-to-bracket"></i>
                    Check-in
                </a>
                <a href="{{ url_for('admin_add_client') }}" class="quick-action accent">
                    <i class="fa-solid fa-user-plus"></i>
                    New Client
                </a>
                <a href="{{ url_for('admin_add_routine') }}" class="quick-action amber">
                    <i class="fa-solid fa-plus"></i>
                    New Routine
                </a>
                <a href="{{ url_for('admin_add_exercise') }}" class="quick-action red">
                    <i class="fa-solid fa-dumbbell"></i>
                    Add Exercise
                </a>
            </div>
        </div>

        <!-- Currently in Gym -->
        <div class="card" style="margin-bottom:0; flex:1;">
            <div class="card-header" style="margin-bottom:10px;">
                <div class="card-title" style="font-size:15px;">
                    <span style="color:var(--emerald);">‚óè</span> Live Gym
                </div>
                <span class="badge badge-emerald">{{ currently_in | default(0) }} inside</span>
            </div>

            <!-- Occupancy bar -->
            {% set cap = gym_capacity | default(50) %}
            {% set pct = ((currently_in | default(0) / cap) * 100) | int %}
            <div style="font-size:11px; color:var(--text-muted); display:flex; justify-content:space-between;">
                <span>Occupancy</span>
                <span>{{ pct }}% of {{ cap }}</span>
            </div>
            <div class="occupancy-bar-track">
                <div class="occupancy-bar-fill" style="width:{{ pct }}%;"></div>
            </div>

            <div style="margin-top:14px;">
                {% if attendance_list %}
                    {% for record in attendance_list %}
                        {% if not record.check_out_time %}
                        <div class="live-client">
                            <div class="live-avatar" style="width:30px;height:30px;font-size:12px;">
                                {{ record.client_name[0] | upper if record.client_name else '?' }}
                            </div>
                            <div class="live-client-info">
                                <div class="live-client-name">{{ record.client_name }}</div>
                                <div class="live-client-meta">In since {{ record.check_in_time }}</div>
                            </div>
                            <div class="live-dot"></div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                <div style="text-align:center; padding:16px; color:var(--text-muted); font-size:13px;">
                    Gym is empty right now
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ Bottom row ‚îÄ‚îÄ -->
<div class="grid grid-3">

    <!-- Top performers -->
    <div class="card" style="margin-bottom:0;">
        <div class="card-header">
            <div class="card-title"><span class="card-title-icon">üèÜ</span> Top EXP This Week</div>
            <a href="{{ url_for('admin_leaderboard') }}" class="btn btn-ghost btn-sm">Full Board</a>
        </div>
        {% if top_exp_week %}
            {% for row in top_exp_week[:5] %}
            <div class="performer-row">
                <div class="performer-rank-num {% if loop.index == 1 %}gold{% elif loop.index == 2 %}silver{% elif loop.index == 3 %}bronze{% endif %}">
                    #{{ loop.index }}
                </div>
                <div class="performer-name">{{ row.full_name }}</div>
                <div class="performer-value">{{ row.total_exp }}</div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state" style="padding:24px 0;">
                <i class="fa-solid fa-trophy" style="font-size:24px;"></i>
                <p>No data yet</p>
            </div>
        {% endif %}
    </div>

    <!-- Recent activity feed -->
    <div class="card" style="margin-bottom:0;">
        <div class="card-title" style="margin-bottom:14px;"><span class="card-title-icon">üì°</span> Recent Activity</div>
        {% if attendance_list %}
            {% for record in attendance_list[:6] %}
            <div class="activity-item">
                <div class="activity-icon checkin"><i class="fa-solid fa-right-to-bracket"></i></div>
                <div style="flex:1;">
                    <div class="activity-text">
                        <strong>{{ record.client_name }}</strong> checked in
                    </div>
                    <div class="activity-time">{{ record.check_in_time }}</div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state" style="padding:24px 0;">
                <i class="fa-solid fa-rss" style="font-size:24px;"></i>
                <p>No recent activity</p>
            </div>
        {% endif %}
    </div>

    <!-- System info -->
    <div class="card" style="margin-bottom:0;">
        <div class="card-title" style="margin-bottom:14px;"><span class="card-title-icon">‚öôÔ∏è</span> System</div>
        <div class="sys-row">
            <span class="sys-label">Server Status</span>
            <span class="sys-val" style="color:var(--emerald);">
                <i class="fa-solid fa-circle" style="font-size:8px;"></i> Online
            </span>
        </div>
        <div class="sys-row">
            <span class="sys-label">Database</span>
            <span class="sys-val">SQLite</span>
        </div>
        <div class="sys-row">
            <span class="sys-label">Admin</span>
            <span class="sys-val">{{ session.admin_username }}</span>
        </div>
        <div class="sys-row">
            <span class="sys-label">Total Clients</span>
            <span class="sys-val" style="color:var(--accent);">{{ total_clients }}</span>
        </div>
        <div class="sys-row">
            <span class="sys-label">Weekly Visits</span>
            <span class="sys-val">{{ weekly_visits }}</span>
        </div>
        <hr class="divider">
        <a href="{{ url_for('admin_clients') }}" class="btn btn-primary" style="width:100%; justify-content:center;">
            <i class="fa-solid fa-users"></i> View All Clients
        </a>
    </div>

</div>

{% endblock %}