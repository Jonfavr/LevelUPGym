<!-- templates/admin/routine_details.html -->
{% extends "admin/base.html" %}

{% block title %}{{ routine.routine_name }} — Builder{% endblock %}
{% block page_title %}Routine Builder{% endblock %}

{% block extra_css %}
<style>
    /* ══════════════════════════════════════
       BUILDER LAYOUT — two columns
    ══════════════════════════════════════ */
    .builder-layout {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 20px;
        align-items: start;
    }

    /* ── Left: Exercise Library ── */
    .library-panel {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        position: sticky;
        top: 24px;
        max-height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
    }

    .library-header {
        padding: 18px 20px 14px;
        border-bottom: 1px solid var(--border);
        background: var(--bg-elevated);
        flex-shrink: 0;
    }

    .library-header h3 {
        font-family: 'Rajdhani', sans-serif;
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 10px;
    }

    .lib-search-wrap {
        position: relative;
        margin-bottom: 10px;
    }

    .lib-search-wrap i {
        position: absolute;
        left: 10px; top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 12px;
        pointer-events: none;
    }

    #lib-search {
        padding-left: 30px;
        height: 34px;
        font-size: 13px;
    }

    .lib-filters {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .lib-filter {
        padding: 3px 10px;
        border-radius: 20px;
        border: 1px solid var(--border);
        background: var(--bg-hover);
        color: var(--text-muted);
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        white-space: nowrap;
    }

    .lib-filter:hover, .lib-filter.active {
        border-color: var(--accent);
        color: var(--accent);
        background: var(--accent-glow);
    }

    /* Exercise list inside library */
    .library-list {
        overflow-y: auto;
        flex: 1;
        padding: 10px;
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
    }

    .lib-ex-card {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 10px 12px;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: border-color 0.15s;
        cursor: default;
    }

    .lib-ex-card:hover { border-color: var(--border-accent); }
    .lib-ex-card.already-added { opacity: 0.45; pointer-events: none; }

    .lib-ex-info { flex: 1; min-width: 0; }

    .lib-ex-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .lib-ex-meta {
        font-size: 10.5px;
        color: var(--text-muted);
        margin-top: 1px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .lib-add-btn {
        flex-shrink: 0;
        width: 28px; height: 28px;
        border-radius: 50%;
        border: 1px solid var(--border);
        background: var(--bg-hover);
        color: var(--text-muted);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.15s;
    }

    .lib-add-btn:hover {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
    }

    /* Difficulty dot */
    .diff-dot {
        width: 7px; height: 7px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .diff-beginner     { background: var(--emerald); }
    .diff-intermediate { background: var(--amber); }
    .diff-advanced     { background: var(--red); }

    /* ── Right: Routine ── */
    .builder-right { display: flex; flex-direction: column; gap: 16px; }

    /* Routine meta card */
    .routine-meta-card {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px 24px;
        position: relative;
        overflow: hidden;
    }

    .routine-meta-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
    }

    .routine-title-row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
    }

    .routine-title {
        font-family: 'Rajdhani', sans-serif;
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .routine-desc {
        font-size: 13px;
        color: var(--text-muted);
    }

    /* EXP counter */
    .exp-counter {
        text-align: center;
        flex-shrink: 0;
    }

    .exp-counter-val {
        font-family: 'Rajdhani', sans-serif;
        font-size: 36px;
        font-weight: 700;
        color: var(--accent);
        line-height: 1;
    }

    .exp-counter-lbl {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        margin-top: 2px;
    }

    /* ── Exercise rows in builder ── */
    .builder-ex-list { display: flex; flex-direction: column; gap: 10px; }

    .builder-ex-card {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: border-color 0.2s;
    }

    .builder-ex-card:hover { border-color: var(--border-accent); }

    .builder-ex-top {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
    }

    .order-badge {
        width: 28px; height: 28px;
        border-radius: 50%;
        background: var(--accent-glow);
        border: 1px solid var(--border-accent);
        display: flex; align-items: center; justify-content: center;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700; font-size: 13px;
        color: var(--accent);
        flex-shrink: 0;
    }

    .builder-ex-name {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
        min-width: 0;
    }

    .builder-ex-sub {
        font-size: 11.5px;
        color: var(--text-muted);
        margin-top: 1px;
    }

    /* Move up/down arrows */
    .move-btns {
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex-shrink: 0;
    }

    .move-btn {
        width: 22px; height: 22px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--bg-elevated);
        color: var(--text-muted);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        font-size: 10px;
        transition: all 0.15s;
    }

    .move-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
    .move-btn:disabled { opacity: 0.25; pointer-events: none; }

    /* Builder exercise controls */
    .builder-ex-controls {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .ctrl-group {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .ctrl-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: var(--text-muted);
        font-weight: 600;
    }

    .ctrl-input {
        width: 70px;
        height: 32px;
        font-size: 14px;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
        text-align: center;
        padding: 0 6px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        transition: border-color 0.2s;
    }

    .ctrl-input:focus { outline: none; border-color: var(--accent); }

    .ctrl-select {
        height: 32px;
        font-size: 12px;
        font-family: 'DM Sans', sans-serif;
        padding: 0 8px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .ctrl-select:focus { outline: none; border-color: var(--accent); }

    .ctrl-exp {
        font-family: 'Rajdhani', sans-serif;
        font-size: 13px;
        font-weight: 700;
        color: var(--accent);
        white-space: nowrap;
    }

    .ctrl-save-btn {
        margin-left: auto;
    }

    /* Empty builder state */
    .builder-empty {
        background: var(--bg-surface);
        border: 2px dashed var(--border);
        border-radius: var(--radius-lg);
        padding: 60px 20px;
        text-align: center;
    }

    .builder-empty i {
        font-size: 40px;
        color: var(--text-muted);
        margin-bottom: 12px;
    }

    .builder-empty p {
        color: var(--text-muted);
        font-size: 14px;
    }

    /* No results */
    #lib-no-results {
        text-align: center;
        padding: 24px 12px;
        color: var(--text-muted);
        font-size: 13px;
        display: none;
    }

    @media (max-width: 900px) {
        .builder-layout { grid-template-columns: 1fr; }
        .library-panel  { position: static; max-height: 420px; }
    }
</style>
{% endblock %}

{% block content %}

<!-- Back + breadcrumb -->
<div style="display:flex; align-items:center; gap:8px; margin-bottom:20px; flex-wrap:wrap;">
    <a href="{{ url_for('admin_routines') }}" class="btn btn-ghost btn-sm">
        <i class="fa-solid fa-arrow-left"></i> All Routines
    </a>
    <span style="color:var(--text-muted); font-size:13px;">/ {{ routine.routine_name }}</span>
</div>

<div class="builder-layout">

    <!-- ════════════════════════════
         LEFT — EXERCISE LIBRARY
    ════════════════════════════ -->
    <div class="library-panel">
        <div class="library-header">
            <h3><i class="fa-solid fa-magnifying-glass" style="color:var(--accent);margin-right:6px;"></i>Exercise Library</h3>

            <!-- Search -->
            <div class="lib-search-wrap">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="lib-search" placeholder="Search exercises…">
            </div>

            <!-- Type filters -->
            <div class="lib-filters" id="type-filters">
                <button class="lib-filter active" data-type="all">All</button>
                <button class="lib-filter" data-type="strength">Strength</button>
                <button class="lib-filter" data-type="cardio">Cardio</button>
                <button class="lib-filter" data-type="core">Core</button>
                <button class="lib-filter" data-type="functional">Functional</button>
                <button class="lib-filter" data-type="power">Power</button>
            </div>
        </div>

        <!-- Library list -->
        <div class="library-list" id="library-list">
            {% for ex in all_exercises %}
            <div class="lib-ex-card {% if ex.exercise_id in added_ids %}already-added{% endif %}"
                 data-ex-id="{{ ex.exercise_id }}"
                 data-name="{{ ex.name | lower }}"
                 data-type="{{ ex.exercise_type | lower }}"
                 data-muscle="{{ ex.target_muscle | lower }}"
                 data-exp="{{ ex.base_exp }}">

                <div class="diff-dot diff-{{ ex.difficulty_level | default('beginner') }}"></div>

                <div class="lib-ex-info">
                    <div class="lib-ex-name" title="{{ ex.name }}">{{ ex.name }}</div>
                    <div class="lib-ex-meta">{{ ex.target_muscle }} · {{ ex.base_exp }} EXP</div>
                </div>

                {% if ex.exercise_id not in added_ids %}
                <form method="POST"
                      action="{{ url_for('admin_add_exercise_to_routine', routine_id=routine.routine_id) }}"
                      class="lib-add-form">
                    <input type="hidden" name="exercise_id" value="{{ ex.exercise_id }}">
                    <input type="hidden" name="sets"        value="3">
                    <input type="hidden" name="reps"        value="10">
                    <input type="hidden" name="rest"        value="60">
                    <input type="hidden" name="measurement" value="reps">
                    <button type="submit" class="lib-add-btn" title="Add to routine">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </form>
                {% else %}
                <div class="lib-add-btn" style="cursor:default; opacity:0.4;" title="Already in routine">
                    <i class="fa-solid fa-check"></i>
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <div id="lib-no-results">
                <i class="fa-solid fa-circle-exclamation" style="font-size:24px; margin-bottom:8px; display:block;"></i>
                No exercises match your search.
            </div>
        </div>
    </div>

    <!-- ════════════════════════════
         RIGHT — ROUTINE BUILDER
    ════════════════════════════ -->
    <div class="builder-right">

        <!-- Routine meta -->
        <div class="routine-meta-card">
            <div class="routine-title-row">
                <div style="flex:1; min-width:0;">
                    <div class="routine-title">{{ routine.routine_name }}</div>
                    <div class="routine-desc">{{ routine.description or 'No description.' }}</div>
                    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                        <span class="badge badge-accent">
                            <i class="fa-solid fa-dumbbell" style="font-size:9px;"></i>
                            {{ exercises | length }} exercise{{ 's' if exercises | length != 1 }}
                        </span>
                        <span class="badge" style="background:var(--bg-hover); color:var(--text-secondary); border:1px solid var(--border);">
                            Created {{ routine.created_date or '—' }}
                        </span>
                    </div>
                </div>
                <!-- Live EXP counter -->
                <div class="exp-counter">
                    <div class="exp-counter-val" id="exp-total">{{ total_exp }}</div>
                    <div class="exp-counter-lbl">Base EXP</div>
                </div>
            </div>
        </div>

        <!-- Exercise list -->
        {% if exercises %}
        <div class="builder-ex-list" id="builder-list">
            {% for ex in exercises %}
            <div class="builder-ex-card"
                 data-re-id="{{ ex.routine_exercise_id }}"
                 data-exp="{{ ex.base_exp }}"
                 data-sets="{{ ex.sets }}">

                <!-- Top row: order + name + move buttons -->
                <div class="builder-ex-top">
                    <div class="order-badge">{{ loop.index }}</div>
                    <div style="flex:1; min-width:0;">
                        <div class="builder-ex-name">{{ ex.name }}</div>
                        <div class="builder-ex-sub">{{ ex.target_muscle }} · {{ ex.exercise_type }}</div>
                    </div>

                    <!-- Move up / Move down -->
                    <div class="move-btns">
                        <form method="POST" action="{{ url_for('admin_move_exercise', routine_id=routine.routine_id, routine_exercise_id=ex.routine_exercise_id, direction='up') }}">
                            <button type="submit" class="move-btn" {% if loop.first %}disabled{% endif %} title="Move up">
                                <i class="fa-solid fa-chevron-up"></i>
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('admin_move_exercise', routine_id=routine.routine_id, routine_exercise_id=ex.routine_exercise_id, direction='down') }}">
                            <button type="submit" class="move-btn" {% if loop.last %}disabled{% endif %} title="Move down">
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                        </form>
                    </div>

                    <!-- Remove -->
                    <form method="POST"
                          action="{{ url_for('delete_routine_exercise', routine_exercise_id=ex.routine_exercise_id) }}"
                          onsubmit="return confirm('Remove {{ ex.name }} from this routine?')">
                        <button type="submit" class="btn btn-danger btn-sm" title="Remove exercise">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </form>
                </div>

                <!-- Controls row: sets / reps / rest / measurement / save -->
                <form method="POST" action="{{ url_for('update_routine_exercise') }}"
                      class="builder-ex-controls ex-update-form"
                      data-re-id="{{ ex.routine_exercise_id }}">
                    <input type="hidden" name="routine_exercise_id" value="{{ ex.routine_exercise_id }}">

                    <div class="ctrl-group">
                        <div class="ctrl-label">Sets</div>
                        <input type="number" name="sets" class="ctrl-input sets-input"
                               value="{{ ex.sets }}" min="1" max="20">
                    </div>

                    <div class="ctrl-group">
                        <div class="ctrl-label">Reps</div>
                        <input type="number" name="reps" class="ctrl-input"
                               value="{{ ex.reps }}" min="1" max="999">
                    </div>

                    <div class="ctrl-group">
                        <div class="ctrl-label">Rest (s)</div>
                        <input type="number" name="rest_seconds" class="ctrl-input"
                               value="{{ ex.rest_seconds }}" min="0" max="600">
                    </div>

                    <div class="ctrl-group">
                        <div class="ctrl-label">Type</div>
                        <select name="measurement" class="ctrl-select">
                            <option value="reps"    {% if ex.measurement == 'reps'    %}selected{% endif %}>Reps</option>
                            <option value="seconds" {% if ex.measurement == 'seconds' %}selected{% endif %}>Seconds</option>
                        </select>
                    </div>

                    <div class="ctrl-group" style="justify-content:flex-end;">
                        <div class="ctrl-label">&nbsp;</div>
                        <span class="ctrl-exp" id="exp-row-{{ ex.routine_exercise_id }}">
                            {{ ex.base_exp * ex.sets }} EXP
                        </span>
                    </div>

                    <button type="submit" class="btn btn-success btn-sm ctrl-save-btn">
                        <i class="fa-solid fa-floppy-disk"></i> Save
                    </button>
                </form>

            </div>
            {% endfor %}
        </div>

        {% else %}
        <div class="builder-empty">
            <i class="fa-solid fa-dumbbell"></i>
            <p>No exercises yet — add some from the library on the left.</p>
        </div>
        {% endif %}

    </div><!-- /builder-right -->
</div><!-- /builder-layout -->

{% endblock %}

{% block extra_js %}
<script>
/* ══════════════════════════════════════════
   LIBRARY — Search + Type Filter
══════════════════════════════════════════ */
const libSearch  = document.getElementById('lib-search');
const libCards   = document.querySelectorAll('.lib-ex-card');
const noResults  = document.getElementById('lib-no-results');
let activeType   = 'all';

function filterLibrary() {
    const q = libSearch.value.toLowerCase().trim();
    let visible = 0;

    libCards.forEach(card => {
        const nameMatch   = card.dataset.name.includes(q);
        const muscleMatch = card.dataset.muscle.includes(q);
        const typeMatch   = activeType === 'all' || card.dataset.type === activeType;
        const show = (nameMatch || muscleMatch) && typeMatch;

        card.style.display = show ? '' : 'none';
        if (show) visible++;
    });

    noResults.style.display = visible === 0 ? 'block' : 'none';
}

libSearch.addEventListener('input', filterLibrary);

document.querySelectorAll('.lib-filter').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.lib-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeType = btn.dataset.type;
        filterLibrary();
    });
});

/* ══════════════════════════════════════════
   LIVE EXP COUNTER — updates when sets change
══════════════════════════════════════════ */
const expTotalEl = document.getElementById('exp-total');

function recalcTotalExp() {
    let total = 0;
    document.querySelectorAll('.builder-ex-card').forEach(card => {
        const baseExp = parseInt(card.dataset.exp) || 0;
        const setsInput = card.querySelector('.sets-input');
        const sets = setsInput ? parseInt(setsInput.value) || 0 : parseInt(card.dataset.sets) || 0;
        total += baseExp * sets;

        // Update per-row EXP label
        const reId = card.dataset.reId;
        const rowExp = document.getElementById('exp-row-' + reId);
        if (rowExp) rowExp.textContent = (baseExp * sets) + ' EXP';
    });

    if (expTotalEl) expTotalEl.textContent = total;
}

document.querySelectorAll('.sets-input').forEach(input => {
    input.addEventListener('input', recalcTotalExp);
});

// Run once on load
recalcTotalExp();
</script>
{% endblock %}