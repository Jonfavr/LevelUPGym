{% extends "admin/base.html" %}
{% block title %}Admin Users — LevelUp Gym{% endblock %}

{% block extra_css %}
<style>
    /* ── Role chips ── */
    .role-chip {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 4px 12px; border-radius: 20px;
        font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
    }
    .role-superadmin {
        background: rgba(102,126,234,0.15);
        color: var(--accent);
        border: 1px solid var(--border-accent);
    }
    .role-staff {
        background: rgba(16,185,129,0.1);
        color: var(--emerald);
        border: 1px solid rgba(16,185,129,0.3);
    }

    /* ── Status chip ── */
    .status-chip {
        display: inline-flex; align-items: center; gap: 5px;
        padding: 3px 10px; border-radius: 20px;
        font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
    }
    .status-active   { background: rgba(16,185,129,0.1);  color: var(--emerald); border: 1px solid rgba(16,185,129,0.3); }
    .status-inactive { background: rgba(239,68,68,0.08);  color: var(--red);     border: 1px solid rgba(239,68,68,0.25); }

    /* ── Avatar ── */
    .user-avatar {
        width: 38px; height: 38px; border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        display: flex; align-items: center; justify-content: center;
        font-family: 'Rajdhani', sans-serif; font-size: 16px; font-weight: 700; color: white;
        flex-shrink: 0;
    }
    .user-avatar.inactive { filter: grayscale(0.8); opacity: 0.6; }

    /* ── You badge ── */
    .you-badge {
        font-size: 10px; padding: 2px 7px; border-radius: 10px;
        background: rgba(251,191,36,0.12); color: var(--amber);
        border: 1px solid rgba(251,191,36,0.3);
        font-weight: 700; letter-spacing: 0.5px;
        vertical-align: middle; margin-left: 6px;
    }

    /* ── Action buttons ── */
    .btn-icon {
        width: 32px; height: 32px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--bg-elevated);
        color: var(--text-muted);
        display: inline-flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s; font-size: 13px;
        text-decoration: none;
    }
    .btn-icon:hover { border-color: var(--border-accent); color: var(--accent); }
    .btn-icon.danger:hover { border-color: rgba(239,68,68,0.4); color: var(--red); background: rgba(239,68,68,0.08); }
    .btn-icon.warn:hover   { border-color: rgba(251,191,36,0.4); color: var(--amber); background: rgba(251,191,36,0.08); }

    /* ── Empty state ── */
    .empty-state {
        text-align: center; padding: 60px 20px;
        color: var(--text-muted);
    }
    .empty-state i { font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block; }

    /* ── Modal backdrop ── */
    .modal-backdrop {
        position: fixed; inset: 0; z-index: 200;
        background: rgba(0,0,0,0.7);
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
        opacity: 0; pointer-events: none;
        transition: opacity 0.2s;
    }
    .modal-backdrop.open { opacity: 1; pointer-events: auto; }

    .modal {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 32px;
        width: 100%; max-width: 460px;
        box-shadow: 0 24px 64px rgba(0,0,0,0.6);
        transform: translateY(16px);
        transition: transform 0.25s cubic-bezier(0.34,1.2,0.64,1);
        position: relative;
        overflow: hidden;
    }
    .modal-backdrop.open .modal { transform: translateY(0); }

    /* Accent top line on modal */
    .modal::before {
        content: '';
        position: absolute; top: 0; left: 0; right: 0; height: 2px;
        background: linear-gradient(90deg, transparent, var(--accent), var(--accent-2), transparent);
    }

    .modal-title {
        font-family: 'Rajdhani', sans-serif;
        font-size: 20px; font-weight: 700;
        color: var(--text-primary); margin-bottom: 4px;
    }
    .modal-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 24px; }
    .modal-close {
        position: absolute; top: 16px; right: 16px;
        background: none; border: none; cursor: pointer;
        color: var(--text-muted); font-size: 16px;
        transition: color 0.2s;
    }
    .modal-close:hover { color: var(--text-primary); }

    /* Form elements inside modal */
    .form-group { margin-bottom: 16px; }
    .form-label {
        display: block; font-size: 11px; font-weight: 600;
        letter-spacing: 1px; text-transform: uppercase;
        color: var(--text-secondary); margin-bottom: 7px;
    }
    .form-input, .form-select {
        width: 100%;
        padding: 11px 14px;
        background: var(--bg-elevated);
        border: 1.5px solid var(--border);
        border-radius: var(--radius-sm);
        font-family: 'DM Sans', sans-serif;
        font-size: 14px; color: var(--text-primary);
        transition: border-color 0.2s, box-shadow 0.2s;
        outline: none;
    }
    .form-input::placeholder { color: var(--text-muted); }
    .form-input:focus, .form-select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .form-select option { background: var(--bg-elevated); }
    .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 5px; }

    .modal-actions {
        display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px;
    }
    .btn-cancel {
        padding: 10px 20px;
        background: var(--bg-elevated); border: 1px solid var(--border);
        border-radius: var(--radius-sm); color: var(--text-secondary);
        font-family: 'DM Sans', sans-serif; font-size: 14px;
        cursor: pointer; transition: all 0.2s;
    }
    .btn-cancel:hover { border-color: var(--border-accent); color: var(--text-primary); }
    .btn-submit {
        padding: 10px 22px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        border: none; border-radius: var(--radius-sm);
        font-family: 'Rajdhani', sans-serif; font-size: 15px; font-weight: 700;
        letter-spacing: 1px; color: white;
        cursor: pointer; transition: filter 0.2s;
    }
    .btn-submit:hover { filter: brightness(1.12); }
    .btn-submit.danger {
        background: linear-gradient(135deg, #991b1b, var(--red));
    }

    /* ── Role explanation box ── */
    .role-explainer {
        display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        margin-bottom: 16px;
    }
    .role-card {
        padding: 12px 14px;
        border-radius: var(--radius-sm);
        border: 1.5px solid var(--border);
        cursor: pointer; transition: all 0.2s;
    }
    .role-card.selected-superadmin { border-color: var(--accent); background: rgba(102,126,234,0.08); }
    .role-card.selected-staff      { border-color: var(--emerald); background: rgba(16,185,129,0.08); }
    .role-card-name {
        font-family: 'Rajdhani', sans-serif; font-size: 14px; font-weight: 700;
        margin-bottom: 4px;
    }
    .role-card-desc { font-size: 11px; color: var(--text-muted); line-height: 1.4; }

    /* ── Info banner ── */
    .info-banner {
        display: flex; align-items: flex-start; gap: 10px;
        padding: 12px 16px; border-radius: var(--radius-sm);
        background: rgba(102,126,234,0.08);
        border: 1px solid var(--border-accent);
        font-size: 13px; color: var(--text-secondary);
        margin-bottom: 24px;
    }
    .info-banner i { color: var(--accent); margin-top: 1px; flex-shrink: 0; }

    /* ── Table ── */
    .users-table { width: 100%; border-collapse: collapse; }
    .users-table th {
        padding: 10px 16px; text-align: left;
        font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
        color: var(--text-muted); border-bottom: 1px solid var(--border);
    }
    .users-table td {
        padding: 14px 16px; border-bottom: 1px solid var(--border);
        vertical-align: middle;
    }
    .users-table tr:last-child td { border-bottom: none; }
    .users-table tr { transition: background 0.15s; }
    .users-table tr:hover td { background: var(--bg-elevated); }
</style>
{% endblock %}

{% block content %}
<div class="section-header" style="margin-bottom: 24px;">
    <div>
        <div class="section-title">
            <div class="title-icon"><i class="fa-solid fa-users-gear"></i></div>
            Admin Users
        </div>
        <div class="section-subtitle">{{ users|length }} user{{ 's' if users|length != 1 else '' }} — manage portal access and roles</div>
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        <i class="fa-solid fa-plus"></i> New User
    </button>
</div>

<!-- Role info banner -->
<div class="info-banner" style="max-width: 700px; margin-bottom: 24px;">
    <i class="fa-solid fa-circle-info"></i>
    <span>
        <strong style="color:var(--text-primary);">Superadmin</strong> — full access including this page.&nbsp;&nbsp;
        <strong style="color:var(--text-primary);">Staff</strong> — access to all gym management tools, but cannot create, edit, or delete admin users.
    </span>
</div>

<!-- Users table card -->
<div class="card">
    {% if users %}
    <table class="users-table">
        <thead>
            <tr>
                <th>User</th>
                <th>Username</th>
                <th>Role</th>
                <th>Status</th>
                <th>Created</th>
                <th style="text-align:right; padding-right:20px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <!-- Avatar + name -->
                <td>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="user-avatar {% if not user.is_active %}inactive{% endif %}">
                            {{ user.full_name[0]|upper }}
                        </div>
                        <div>
                            <div style="font-size:14px; font-weight:600; color:var(--text-primary);">
                                {{ user.full_name }}
                                {% if user.user_id == session.admin_user_id %}
                                    <span class="you-badge">YOU</span>
                                {% endif %}
                            </div>
                            <div style="font-size:11px; color:var(--text-muted);">ID #{{ user.user_id }}</div>
                        </div>
                    </div>
                </td>

                <!-- Username -->
                <td>
                    <code style="font-size:13px; color:var(--text-secondary); background:var(--bg-elevated); padding:3px 8px; border-radius:4px;">
                        {{ user.username }}
                    </code>
                </td>

                <!-- Role -->
                <td>
                    <span class="role-chip role-{{ user.role }}">
                        <i class="fa-solid {% if user.role == 'superadmin' %}fa-shield-halved{% else %}fa-user{% endif %}"></i>
                        {{ user.role|capitalize }}
                    </span>
                </td>

                <!-- Status -->
                <td>
                    <span class="status-chip {% if user.is_active %}status-active{% else %}status-inactive{% endif %}">
                        <i class="fa-solid fa-circle" style="font-size:7px;"></i>
                        {{ 'Active' if user.is_active else 'Inactive' }}
                    </span>
                </td>

                <!-- Created -->
                <td style="font-size:12px; color:var(--text-muted);">
                    {{ user.created_at[:10] if user.created_at else '—' }}
                    {% if user.created_by %}
                    <div style="font-size:11px;">by {{ user.created_by }}</div>
                    {% endif %}
                </td>

                <!-- Actions -->
                <td>
                    <div style="display:flex; gap:6px; justify-content:flex-end;">
                        <!-- Edit -->
                        <button class="btn-icon"
                                title="Edit user"
                                onclick="openEditModal({{ user.user_id }}, '{{ user.username }}', '{{ user.full_name }}', '{{ user.role }}')">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                        <!-- Toggle active — disabled for self -->
                        {% if user.user_id != session.admin_user_id %}
                        <form method="POST" action="{{ url_for('admin_toggle_user', user_id=user.user_id) }}" style="margin:0;">
                            <button type="submit" class="btn-icon warn"
                                    title="{{ 'Deactivate' if user.is_active else 'Activate' }} user">
                                <i class="fa-solid {% if user.is_active %}fa-ban{% else %}fa-check{% endif %}"></i>
                            </button>
                        </form>

                        <!-- Delete -->
                        <button class="btn-icon danger"
                                title="Delete user"
                                onclick="openDeleteModal({{ user.user_id }}, '{{ user.username }}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        {% else %}
                        <!-- Placeholder to keep layout aligned -->
                        <div style="width:32px;"></div>
                        <div style="width:32px;"></div>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <i class="fa-solid fa-users-slash"></i>
        <p style="font-size:16px; margin-bottom:8px;">No admin users yet</p>
        <p style="font-size:13px;">Create the first user to get started.</p>
    </div>
    {% endif %}
</div>


<!-- ══════════════════════════════════════════════
     CREATE MODAL
══════════════════════════════════════════════ -->
<div class="modal-backdrop" id="create-modal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('create-modal')">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="modal-title">New Admin User</div>
        <div class="modal-sub">Grant portal access with a specific role</div>

        <form method="POST" action="{{ url_for('admin_create_user') }}">
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input class="form-input" type="text" name="full_name" placeholder="e.g. Maria González" required>
            </div>
            <div class="form-group">
                <label class="form-label">Username</label>
                <input class="form-input" type="text" name="username" placeholder="e.g. maria_g" required autocomplete="off">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input class="form-input" type="password" name="password" placeholder="Min. 6 characters" required autocomplete="new-password">
                <div class="form-hint">The user can change this after logging in.</div>
            </div>

            <div class="form-group">
                <label class="form-label">Role</label>
                <div class="role-explainer" id="create-role-cards">
                    <div class="role-card" id="card-staff-create" onclick="selectRole('create', 'staff')">
                        <div class="role-card-name" style="color:var(--emerald);">Staff</div>
                        <div class="role-card-desc">Full gym management. Cannot manage admin users.</div>
                    </div>
                    <div class="role-card" id="card-superadmin-create" onclick="selectRole('create', 'superadmin')">
                        <div class="role-card-name" style="color:var(--accent);">Superadmin</div>
                        <div class="role-card-desc">Unrestricted access. Can manage other users.</div>
                    </div>
                </div>
                <input type="hidden" name="role" id="create-role-input" value="staff">
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('create-modal')">Cancel</button>
                <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-plus"></i> Create User
                </button>
            </div>
        </form>
    </div>
</div>


<!-- ══════════════════════════════════════════════
     EDIT MODAL
══════════════════════════════════════════════ -->
<div class="modal-backdrop" id="edit-modal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('edit-modal')">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="modal-title">Edit User</div>
        <div class="modal-sub" id="edit-modal-sub">Update user details</div>

        <form method="POST" id="edit-form">
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input class="form-input" type="text" name="full_name" id="edit-full-name" required>
            </div>
            <div class="form-group">
                <label class="form-label">New Password <span style="color:var(--text-muted); font-weight:400;">(leave blank to keep current)</span></label>
                <input class="form-input" type="password" name="password" placeholder="Leave blank to keep current" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label class="form-label">Role</label>
                <div class="role-explainer">
                    <div class="role-card" id="card-staff-edit" onclick="selectRole('edit', 'staff')">
                        <div class="role-card-name" style="color:var(--emerald);">Staff</div>
                        <div class="role-card-desc">Full gym management. Cannot manage admin users.</div>
                    </div>
                    <div class="role-card" id="card-superadmin-edit" onclick="selectRole('edit', 'superadmin')">
                        <div class="role-card-name" style="color:var(--accent);">Superadmin</div>
                        <div class="role-card-desc">Unrestricted access. Can manage other users.</div>
                    </div>
                </div>
                <input type="hidden" name="role" id="edit-role-input" value="staff">
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('edit-modal')">Cancel</button>
                <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-floppy-disk"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>


<!-- ══════════════════════════════════════════════
     DELETE CONFIRM MODAL
══════════════════════════════════════════════ -->
<div class="modal-backdrop" id="delete-modal">
    <div class="modal" style="max-width:400px;">
        <button class="modal-close" onclick="closeModal('delete-modal')">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <div style="text-align:center; padding: 8px 0 20px;">
            <div style="width:60px; height:60px; border-radius:50%; background:var(--red-glow); border:1.5px solid rgba(239,68,68,0.3); display:flex; align-items:center; justify-content:center; margin:0 auto 16px; font-size:26px; color:var(--red);">
                <i class="fa-solid fa-trash"></i>
            </div>
            <div class="modal-title">Delete User</div>
            <div class="modal-sub" id="delete-modal-sub" style="margin-bottom:0;">This action cannot be undone.</div>
        </div>
        <form method="POST" id="delete-form">
            <div class="modal-actions" style="justify-content:center;">
                <button type="button" class="btn-cancel" onclick="closeModal('delete-modal')">Cancel</button>
                <button type="submit" class="btn-submit danger">
                    <i class="fa-solid fa-trash"></i> Delete
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/* ── Modal helpers ── */
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-backdrop').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

/* ── Role card selection ── */
function selectRole(context, role) {
    const input = document.getElementById(`${context}-role-input`);
    input.value = role;

    ['staff','superadmin'].forEach(r => {
        const card = document.getElementById(`card-${r}-${context}`);
        card.classList.remove('selected-staff','selected-superadmin');
    });
    document.getElementById(`card-${role}-${context}`).classList.add(`selected-${role}`);
}

/* ── Create modal ── */
function openCreateModal() {
    selectRole('create', 'staff'); // default
    openModal('create-modal');
}

/* ── Edit modal ── */
function openEditModal(userId, username, fullName, role) {
    document.getElementById('edit-modal-sub').textContent = `Editing @${username}`;
    document.getElementById('edit-form').action = `/admin/users/${userId}/edit`;
    document.getElementById('edit-full-name').value = fullName;
    selectRole('edit', role);
    openModal('edit-modal');
}

/* ── Delete modal ── */
function openDeleteModal(userId, username) {
    document.getElementById('delete-modal-sub').textContent = `User "@${username}" will be permanently removed.`;
    document.getElementById('delete-form').action = `/admin/users/${userId}/delete`;
    openModal('delete-modal');
}
</script>
{% endblock %}
