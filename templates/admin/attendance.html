<!-- templates/admin/attendance.html -->
{% extends "admin/base.html" %}

{% block title %}Attendance - Admin{% endblock %}

{% block content %}
<div class="card">
    <h1>Attendance Management</h1>
    <p>Manually check clients in and out, or view today's attendance</p>
</div>

<div class="grid grid-2">
    <div class="card">
    <h2>Check-in Client by Phone Number</h2>
    <form id="checkin-form" method="POST" action="{{ url_for('admin_checkin') }}">
        <div class="form-group">
            <label for="client-phone">Client Phone Number</label>
            <input type="text" id="client-phone" name="phone_number" required placeholder="Enter Phone Number" maxlength="10">
            <input type="text" id="client-id" name="client_id" required style="display: none;">
        </div>
        <div id="client-info" style="display:none; padding-top: 10px;">
            <p><strong>Client Name:</strong> <span id="client-name"></span></p>
            <p><strong>Status:</strong> <span id="client-status"></span></p>
        </div>
        <button type="submit" class="btn btn-disabled" style="width: 100%;" id="checkin-button" disabled>Check In Client</button>
    </form>
    </div>
</div>

<div class="card">
    <h2>Today's Attendance ({{ attendance_list|length }} clients)</h2>
    {% if attendance_list %}
    <table>
        <thead>
            <tr>
                <th>Client Name</th>
                <th>Phone</th>
                <th>Check-in Time</th>
                <th>Check-out Time</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for record in attendance_list %}
            <tr>
                <td><strong>{{ record.client_name }}</strong></td>
                <td>{{ record.phone_number }}</td>
                <td>{{ record.check_in_time }}</td>
                <td>
                    {% if record.check_out_time %}
                        {{ record.check_out_time }}
                    {% else %}
                        <span style="color: #9ca3af;">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if record.check_out_time %}
                        <span style="color: #6b7280; background: #f3f4f6; padding: 4px 8px; border-radius: 4px;">Completed</span>
                    {% else %}
                        <span style="color: #10b981; background: #d1fae5; padding: 4px 8px; border-radius: 4px; font-weight: 600;">ðŸ’ª In Gym</span>
                    {% endif %}
                </td>
                <td><form id="checkou-form" method="POST" action="{{ url_for('admin_checkout') }}"> 
                    <input id="client-id" name="client_id" type="text" value="{{ record.client_id}}" style="display: none;"> 
                    {% if record.check_out_time %}
                    <button class="btn btn-disabled" disabled="true">Checked Out</button>
                    {% else %}
                    <button class="btn btn-primary">Check Out</button>
                    {% endif %}
                </form></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #6b7280; padding: 40px; text-align: center; font-size: 16px;">
        No attendance records for today yet. Start checking in clients! ðŸ‘‹
    </p>
    {% endif %}
</div>
<script>
document.getElementById('client-phone').addEventListener('input', async function() {
    const phoneNumber = this.value.trim();
    const button = document.getElementById('checkin-button');
    button.disabled = true;
    
    // Only allow 10-digit phone numbers
    if (phoneNumber.length === 10) {
        try {
            const response = await fetch('/get_client_by_phone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ phone_number: phoneNumber })
            });

            const result = await response.json();
            
            if (result.success) {
                // Show client information and enable the button
                document.getElementById('client-name').textContent = result.client_name;
                document.getElementById('client-status').textContent = result.client_status;
                document.getElementById('client-id').value = result.client_id;
                document.getElementById('client-info').style.display = 'block';
                console.log(result.client_status);
                if (result.client_status == "active") {
                    button.classList.remove('btn-disabled');
                    button.classList.add('btn-success');
                    button.disabled = false;
                } else {
                    
                    button.disabled = true;
                }
                
            } else {
                // If client is not found, hide client info and disable button
                document.getElementById('client-info').style.display = 'none';
                document.getElementById('client-id').value = '';
                button.disabled = true;
            }
        } catch (error) {
            console.error('Error fetching client data:', error);
        }
    } else {
        document.getElementById('client-info').style.display = 'none';
        document.getElementById('client-id').value = '';
        button.disabled = true;
    }
});
</script>

{% endblock %}