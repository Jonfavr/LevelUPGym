{% extends "base.html" %}
{% block title %}LevelUP Gym{% endblock %}

{% block extra_css %}
<style>
    /* Override base padding ‚Äî no nav on login */
    body {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background-image:
            radial-gradient(ellipse 60% 50% at 20% 80%, rgba(124,92,252,0.18) 0%, transparent 60%),
            radial-gradient(ellipse 50% 40% at 80% 20%, rgba(0,229,160,0.1) 0%, transparent 55%) !important;
    }

    .container {
        padding: 0 !important;
        width: 100%;
        max-width: 420px;
    }

    /* ‚îÄ‚îÄ Login shell ‚îÄ‚îÄ */
    .login-shell {
        min-height: 100vh;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px 20px;
    }

    .login-card {
        width: 100%;
        max-width: 380px;
    }

    /* ‚îÄ‚îÄ Logo ‚îÄ‚îÄ */
    .login-logo {
        text-align: center;
        margin-bottom: 36px;
    }

    .login-logo img {
        width: 50vw;
        max-width: 200px;
        height: auto;
        filter: drop-shadow(0 0 12px rgba(124,92,252,0.4));
        background: transparent;
        margin-bottom: 12px;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .login-logo-name {
        font-family: var(--font-display);
        font-size: 36px;
        font-weight: 800;
        letter-spacing: 2px;
        color: var(--text);
        text-transform: uppercase;
        line-height: 1;
    }

    .login-logo-name span { color: var(--brand); }

    .login-logo-sub {
        font-size: 12px;
        color: var(--text-muted);
        font-weight: 600;
        letter-spacing: 3px;
        text-transform: uppercase;
        margin-top: 6px;
        display: block;
    }

    /* ‚îÄ‚îÄ Flash messages ‚îÄ‚îÄ */
    .login-alert {
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        margin-bottom: 20px;
        font-size: 13px;
        font-weight: 500;
    }
    .login-alert.error   { background: rgba(255,71,87,0.12);  color: #ff9da6; border: 1px solid rgba(255,71,87,0.3); }
    .login-alert.success { background: rgba(0,229,160,0.1);   color: #6effd7; border: 1px solid rgba(0,229,160,0.25); }
    .login-alert.info    { background: rgba(124,92,252,0.1);  color: #c4b5fd; border: 1px solid rgba(124,92,252,0.25); }

    /* ‚îÄ‚îÄ Step 1: Phone ‚îÄ‚îÄ */
    .step { width: 100%; transition: opacity 0.3s ease; }
    .step.hidden { display: none; }
    .step.fading { opacity: 0; pointer-events: none; }

    .step-label {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--text-muted);
        margin-bottom: 8px;
        font-family: var(--font-display);
    }

    .step-title {
        font-family: var(--font-display);
        font-size: 28px;
        font-weight: 800;
        text-transform: uppercase;
        color: var(--text);
        margin-bottom: 24px;
        line-height: 1;
    }

    .phone-input-wrap {
        position: relative;
        margin-bottom: 20px;
    }

    .phone-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        pointer-events: none;
        color: var(--text-muted);
    }

    .phone-input {
        width: 100%;
        background: var(--surface-2);
        border: 1.5px solid var(--border);
        color: var(--text);
        border-radius: var(--radius-sm);
        padding: 16px 16px 16px 46px;
        font-size: 18px;
        font-weight: 600;
        font-family: var(--font-display);
        letter-spacing: 1px;
        transition: all 0.2s;
        -webkit-appearance: none;
    }

    .phone-input::placeholder { color: var(--text-dim); font-size: 15px; letter-spacing: 0; }
    .phone-input:focus {
        outline: none;
        border-color: var(--brand);
        background: rgba(124,92,252,0.08);
        box-shadow: 0 0 0 3px rgba(124,92,252,0.15);
    }

    .btn-continue {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, var(--brand), #5e3fde);
        color: #fff;
        border: none;
        border-radius: var(--radius-sm);
        font-family: var(--font-display);
        font-size: 20px;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 6px 24px var(--brand-glow);
    }

    .btn-continue:active { transform: scale(0.97); }

    /* ‚îÄ‚îÄ Step 2: PIN ‚îÄ‚îÄ */
    .pin-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
    }

    .pin-back {
        background: var(--surface-3);
        border: 1px solid var(--border);
        color: var(--text-muted);
        width: 36px; height: 36px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        font-size: 16px;
        flex-shrink: 0;
        transition: all 0.2s;
    }
    .pin-back:hover { color: var(--text); }

    .pin-phone-display {
        font-family: var(--font-display);
        font-size: 17px;
        font-weight: 700;
        color: var(--text-muted);
        letter-spacing: 0.5px;
    }

    /* Dot indicators */
    .pin-dots {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-bottom: 32px;
    }

    .pin-dot {
        width: 18px; height: 18px;
        border-radius: 50%;
        border: 2px solid var(--border-2);
        background: transparent;
        transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .pin-dot.filled {
        background: var(--brand);
        border-color: var(--brand);
        box-shadow: 0 0 10px var(--brand-glow);
        transform: scale(1.15);
    }

    .pin-dot.error-shake {
        animation: dotShake 0.4s ease-out;
        border-color: var(--red);
        background: var(--red);
        box-shadow: 0 0 10px rgba(255,71,87,0.5);
    }

    @keyframes dotShake {
        0%, 100% { transform: translateX(0) scale(1.1); }
        20%       { transform: translateX(-5px) scale(1.1); }
        40%       { transform: translateX(5px) scale(1.1); }
        60%       { transform: translateX(-3px) scale(1.1); }
        80%       { transform: translateX(3px) scale(1.1); }
    }

    /* Numpad */
    .numpad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .num-btn {
        height: 72px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: var(--radius-sm);
        font-family: var(--font-display);
        font-size: 28px;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.1s;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
    }

    .num-btn:active {
        transform: scale(0.93);
        background: rgba(124,92,252,0.15);
        border-color: var(--brand);
    }

    .num-btn.empty {
        background: transparent;
        border-color: transparent;
        cursor: default;
        pointer-events: none;
    }

    .num-btn.delete {
        background: rgba(255,71,87,0.08);
        border-color: rgba(255,71,87,0.2);
        color: var(--red);
        font-size: 22px;
    }

    .num-btn.delete:active {
        background: rgba(255,71,87,0.18);
        border-color: var(--red);
    }

    /* Ripple */
    .num-btn::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at center, rgba(124,92,252,0.3), transparent 70%);
        opacity: 0;
        transition: opacity 0.2s;
    }
    .num-btn:active::after { opacity: 1; }

    /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
    .login-footer {
        text-align: center;
        margin-top: 28px;
        font-size: 12px;
        color: var(--text-dim);
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block content %}
<div class="login-shell">
    <div class="login-card">

        <!-- LOGO -->
        <div class="login-logo">
            <img src="/static/image/levelup_gym_logo.svg" alt="LevelUP Gym">
            <!-- <div class="login-logo-name">LEVEL<span>UP</span></div> -->
            <span class="login-logo-sub">Client Portal</span>
        </div>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="login-alert {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- STEP 1: PHONE -->
        <div class="step" id="step-phone">
            <div class="step-label">Step 1 of 2</div>
            <div class="step-title">Enter your number</div>

            <div class="phone-input-wrap">
                <span class="phone-icon">üì±</span>
                <input type="tel"
                       id="phone-input"
                       class="phone-input"
                       placeholder="Phone number"
                       inputmode="numeric"
                       autocomplete="tel"
                       autofocus>
            </div>

            <button class="btn-continue" onclick="goToPin()">Continue ‚Üí</button>
        </div>

        <!-- STEP 2: PIN -->
        <div class="step hidden" id="step-pin">
            <div class="pin-header">
                <button class="pin-back" onclick="goBack()">‚Üê</button>
                <div class="pin-phone-display" id="phone-display"></div>
            </div>

            <div class="step-label" style="text-align:center;">Step 2 of 2</div>
            <div class="step-title" style="text-align:center; margin-bottom:20px;">Enter your PIN</div>

            <div class="pin-dots">
                <div class="pin-dot" id="dot-0"></div>
                <div class="pin-dot" id="dot-1"></div>
                <div class="pin-dot" id="dot-2"></div>
                <div class="pin-dot" id="dot-3"></div>
            </div>

            <div class="numpad">
                <button class="num-btn" onclick="pressNum('1')">1</button>
                <button class="num-btn" onclick="pressNum('2')">2</button>
                <button class="num-btn" onclick="pressNum('3')">3</button>
                <button class="num-btn" onclick="pressNum('4')">4</button>
                <button class="num-btn" onclick="pressNum('5')">5</button>
                <button class="num-btn" onclick="pressNum('6')">6</button>
                <button class="num-btn" onclick="pressNum('7')">7</button>
                <button class="num-btn" onclick="pressNum('8')">8</button>
                <button class="num-btn" onclick="pressNum('9')">9</button>
                <div class="num-btn empty"></div>
                <button class="num-btn" onclick="pressNum('0')">0</button>
                <button class="num-btn delete" onclick="deleteLast()">‚å´</button>
            </div>
        </div>

        <!-- Hidden form ‚Äî submitted programmatically -->
        <form id="login-form" method="POST" action="{{ url_for('login') }}" style="display:none;">
            <input type="hidden" name="phone" id="hidden-phone">
            <input type="hidden" name="pin"   id="hidden-pin">
        </form>

        <div class="login-footer">
            New here? Ask our staff to create your account.
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let pinValue = '';

    // ‚îÄ‚îÄ Step navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function goToPin() {
        const phone = document.getElementById('phone-input').value.trim();
        if (!phone) {
            document.getElementById('phone-input').style.borderColor = 'var(--red)';
            document.getElementById('phone-input').focus();
            setTimeout(() => {
                document.getElementById('phone-input').style.borderColor = '';
            }, 1500);
            return;
        }
        document.getElementById('hidden-phone').value = phone;
        document.getElementById('phone-display').textContent = phone;

        const s1 = document.getElementById('step-phone');
        const s2 = document.getElementById('step-pin');
        s1.classList.add('fading');
        setTimeout(() => {
            s1.classList.add('hidden');
            s1.classList.remove('fading');
            s2.classList.remove('hidden');
        }, 280);
    }

    function goBack() {
        const s1 = document.getElementById('step-phone');
        const s2 = document.getElementById('step-pin');
        pinValue = '';
        updateDots();
        s2.classList.add('hidden');
        s1.classList.remove('hidden');
    }

    // Allow pressing Enter on phone field
    document.getElementById('phone-input').addEventListener('keydown', e => {
        if (e.key === 'Enter') goToPin();
    });

    // ‚îÄ‚îÄ PIN logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function pressNum(digit) {
        if (pinValue.length >= 4) return;
        pinValue += digit;
        updateDots();
        if (pinValue.length === 4) submitPin();
    }

    function deleteLast() {
        pinValue = pinValue.slice(0, -1);
        updateDots();
    }

    function updateDots() {
        for (let i = 0; i < 4; i++) {
            const dot = document.getElementById('dot-' + i);
            dot.classList.toggle('filled', i < pinValue.length);
            dot.classList.remove('error-shake');
        }
    }

    function submitPin() {
        document.getElementById('hidden-pin').value = pinValue;
        document.getElementById('login-form').submit();
    }

    // Shake dots on error (when page reloads with flash error)
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    {% if category == 'error' %}
    // Already on phone step from server redirect, nothing to shake
    {% endif %}
    {% endfor %}
    {% endif %}
    {% endwith %}

    // Also support keyboard numpad while on PIN step
    document.addEventListener('keydown', e => {
        const pinStep = document.getElementById('step-pin');
        if (pinStep.classList.contains('hidden')) return;
        if (e.key >= '0' && e.key <= '9') pressNum(e.key);
        if (e.key === 'Backspace') deleteLast();
    });
</script>
{% endblock %}