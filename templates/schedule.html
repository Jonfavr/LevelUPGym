{% extends "base.html" %}
{% block title %}Schedule â€“ LevelUP Gym{% endblock %}

{% block extra_css %}
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCHEDULE PAGE  Â·  LevelUP Gym
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.page-header { margin-bottom: 20px; }
.page-header h1 { font-size: 28px; font-weight: 900; margin-bottom: 2px; }
.page-header p  { font-size: 13px; color: var(--text-muted); }

/* â”€â”€ Week overview strip â”€â”€ */
.week-strip {
    display: flex; gap: 6px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px; margin-bottom: 16px;
    overflow-x: auto; scrollbar-width: none;
}
.week-strip::-webkit-scrollbar { display: none; }

.week-day-chip { flex: 1; min-width: 36px; display: flex; flex-direction: column; align-items: center; gap: 6px; }
.week-day-lbl  { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }

.week-day-dot {
    width: 30px; height: 30px; border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; font-family: var(--font-display);
    background: var(--surface-3); border: 1px solid var(--border); color: var(--text-dim);
    transition: all 0.2s;
}
.week-day-dot.has-routine { background: var(--brand-dim);          color: var(--brand);  border-color: var(--brand-glow); }
.week-day-dot.is-done     { background: rgba(0,229,160,0.12);      color: var(--green);  border-color: rgba(0,229,160,0.3); }
.week-day-dot.is-today    { box-shadow: 0 0 0 2px var(--brand); }

/* â”€â”€ Day cards â”€â”€ */
.day-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px 18px; margin-bottom: 10px;
    transition: border-color 0.2s, opacity 0.2s; position: relative;
}
.day-card.is-today  { border-color: var(--brand); box-shadow: 0 0 0 1px var(--brand-glow); }
.day-card.is-past   { opacity: 0.55; }
.day-card.is-future { opacity: 0.7; }
.day-card.rest-only { opacity: 0.45; }

.day-header         { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.day-header-left    { display: flex; align-items: center; gap: 10px; flex: 1; }
.day-name           { font-family: var(--font-display); font-size: 19px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.4px; color: var(--text); }
.day-name.today-label { color: var(--brand); }

.day-badge          { font-size: 11px; font-weight: 700; padding: 3px 9px; border-radius: 99px; text-transform: uppercase; letter-spacing: 0.4px; white-space: nowrap; }
.badge-today        { background: var(--brand-dim);        color: var(--brand);    border: 1px solid var(--brand-glow); }
.badge-rest         { background: var(--surface-3);        color: var(--text-dim); border: 1px solid var(--border); }
.badge-done         { background: rgba(0,229,160,0.1);     color: var(--green);    border: 1px solid rgba(0,229,160,0.3); }
.badge-progress     { background: rgba(255,176,32,0.1);    color: var(--amber);    border: 1px solid rgba(255,176,32,0.3); }
.badge-locked       { background: var(--surface-3);        color: var(--text-dim); border: 1px solid var(--border); }

/* â”€â”€ Edit button â”€â”€ */
.btn-edit-day {
    width: 30px; height: 30px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    background: var(--surface-3); border: 1px solid var(--border);
    color: var(--text-dim); cursor: pointer; transition: all 0.18s;
    font-size: 13px; flex-shrink: 0;
}
.btn-edit-day:hover { background: var(--brand-dim); color: var(--brand); border-color: var(--brand-glow); }

/* â”€â”€ Routine info â”€â”€ */
.routine-name { font-family: var(--font-display); font-size: 21px; font-weight: 800; text-transform: uppercase; color: var(--text); line-height: 1; margin-bottom: 3px; }
.routine-desc { font-size: 12px; color: var(--text-muted); margin-bottom: 14px; line-height: 1.5; }

/* â”€â”€ Action buttons â”€â”€ */
.btn-day {
    display: flex; align-items: center; justify-content: center;
    width: 100%; padding: 13px; border-radius: var(--radius-sm);
    font-family: var(--font-display); font-size: 16px; font-weight: 800;
    letter-spacing: 0.8px; text-transform: uppercase; text-decoration: none;
    border: none; transition: all 0.2s; cursor: pointer;
}
.btn-day:active        { transform: scale(0.97); }
.btn-day-start         { background: linear-gradient(135deg, var(--green), #00c97d); color: #0d1a12; box-shadow: 0 4px 18px var(--green-glow); }
.btn-day-continue      { background: linear-gradient(135deg, var(--amber), #e67e00); color: #fff;    box-shadow: 0 4px 18px rgba(255,176,32,0.35); }
.btn-day-done          { background: var(--surface-3); color: var(--text-dim); cursor: default; pointer-events: none; }
.btn-day-locked        { background: var(--surface-3); color: var(--text-dim); border: 1px dashed var(--border); cursor: not-allowed; font-size: 13px; font-weight: 700; }

.no-routine-text { font-size: 13px; color: var(--text-dim); margin-bottom: 12px; }
.btn-add-routine {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 11px; border-radius: var(--radius-sm);
    font-family: var(--font-display); font-size: 14px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.5px;
    border: 1px dashed var(--brand-glow); background: var(--brand-dim);
    color: var(--brand); cursor: pointer; transition: all 0.18s;
}
.btn-add-routine:hover { background: rgba(124,92,252,0.15); }

.rest-text { font-size: 13px; color: var(--text-dim); padding: 2px 0; font-style: italic; }

/* â”€â”€ Extra Workout â”€â”€ */
.extra-workout-section {
    margin-top: 24px; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius);
    padding: 18px; position: relative; overflow: hidden;
}
.extra-workout-section::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--amber), #ff6b35, var(--amber));
    background-size: 200% 100%;
    animation: shimmer 2.5s ease-in-out infinite;
}
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

.extra-workout-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.extra-workout-icon   { font-size: 22px; line-height: 1; }
.extra-workout-title  { font-family: var(--font-display); font-size: 20px; font-weight: 900; text-transform: uppercase; color: var(--amber); letter-spacing: 0.5px; }
.extra-workout-sub    { font-size: 12px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; }

/* Extra workout â€” two-button row */
.extra-workout-actions {
    display: flex; gap: 10px; align-items: stretch;
}

/* Left: "Choose Routine" pick button */
.btn-extra-pick {
    flex: 1;
    display: flex; align-items: center; justify-content: space-between;
    padding: 13px 16px; border-radius: var(--radius-sm);
    border: 1px solid var(--border); background: var(--surface-3);
    color: var(--text-dim); cursor: pointer;
    font-size: 14px; font-weight: 600;
    transition: all 0.18s; text-align: left; gap: 8px;
}
.btn-extra-pick:hover   { border-color: var(--amber); color: var(--text); background: rgba(255,176,32,0.06); }
.btn-extra-pick #extra-picker-label { flex: 1; }
.btn-extra-pick #extra-picker-label.chosen { font-weight: 700; color: var(--text); }
.btn-extra-pick-icon    { font-size: 18px; opacity: 0.45; transition: opacity 0.18s; flex-shrink: 0; }
.btn-extra-pick:hover .btn-extra-pick-icon { opacity: 0.9; }

/* Right: "Let's Go" start button */
.btn-extra-start {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    padding: 13px 18px; border-radius: var(--radius-sm);
    font-family: var(--font-display); font-size: 15px; font-weight: 900;
    text-transform: uppercase; letter-spacing: 0.6px; border: none; cursor: pointer;
    background: linear-gradient(135deg, var(--amber), #ff6b35);
    color: #fff; box-shadow: 0 4px 18px rgba(255,176,32,0.3);
    transition: all 0.2s; text-decoration: none; white-space: nowrap;
    opacity: 0.38; pointer-events: none; flex-shrink: 0;
}
.btn-extra-start.active              { opacity: 1; pointer-events: auto; }
.btn-extra-start.active:hover        { opacity: 0.9; transform: translateY(-1px); }
.btn-extra-start:active              { transform: scale(0.97); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTINE PICKER MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rpicker-overlay {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(0,0,0,0.72);
    backdrop-filter: blur(6px) saturate(0.8);
    display: flex; align-items: flex-end; justify-content: center;
    padding: 0 12px 16px;          /* â† side gap + bottom lift */
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s ease;
}
.rpicker-overlay.open { opacity: 1; pointer-events: auto; }

.rpicker-sheet {
    width: 100%; max-width: 520px;
    background: var(--surface, #181826);
    border-radius: 22px;           /* â† fully rounded on all corners */
    border: 1px solid var(--border);
    display: flex; flex-direction: column;
    max-height: 82vh;
    transform: translateY(40px);
    transition: transform 0.32s cubic-bezier(0.34, 1.3, 0.64, 1);
    box-shadow: 0 -12px 60px rgba(0,0,0,0.5);
}
.rpicker-overlay.open .rpicker-sheet { transform: translateY(0); }

/* drag pill */
.rpicker-pill {
    width: 38px; height: 4px; background: var(--border);
    border-radius: 99px; margin: 12px auto 0; flex-shrink: 0;
}

/* header */
.rpicker-header {
    padding: 16px 20px 14px;
    display: flex; align-items: flex-start; justify-content: space-between;
    flex-shrink: 0; border-bottom: 1px solid var(--border);
}
.rpicker-title {
    font-family: var(--font-display);
    font-size: 22px; font-weight: 900; text-transform: uppercase;
    letter-spacing: 1px; color: var(--text);
}
.rpicker-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 3px; }
.rpicker-close {
    width: 32px; height: 32px; border-radius: 50%;
    background: var(--surface-3); border: 1px solid var(--border);
    color: var(--text-muted); font-size: 14px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0;
}
.rpicker-close:hover { background: rgba(255,80,80,0.15); color: #ff5050; border-color: rgba(255,80,80,0.3); }

/* scrollable list */
.rpicker-list {
    overflow-y: auto; flex: 1;
    padding: 12px 16px;
    scrollbar-width: thin; scrollbar-color: var(--brand-glow) transparent;
}
.rpicker-list::-webkit-scrollbar       { width: 4px; }
.rpicker-list::-webkit-scrollbar-track { background: transparent; }
.rpicker-list::-webkit-scrollbar-thumb { background: var(--brand-glow); border-radius: 99px; }

/* row */
.rpicker-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 16px; border-radius: 13px;
    border: 1px solid var(--border);
    margin-bottom: 8px; cursor: pointer;
    transition: all 0.14s;
    background: var(--surface-3, rgba(255,255,255,0.04));
    position: relative; overflow: hidden;
}
.rpicker-item::before {
    content: ''; position: absolute;
    left: 0; top: 0; bottom: 0; width: 3px;
    background: var(--brand); border-radius: 0 2px 2px 0;
    opacity: 0; transition: opacity 0.14s;
}
.rpicker-item:hover, .rpicker-item:hover::before { opacity:1; }
.rpicker-item:hover               { border-color: var(--brand-glow); background: var(--brand-dim); }
.rpicker-item.is-selected         { border-color: var(--brand); background: var(--brand-dim); }
.rpicker-item.is-selected::before { opacity: 1; }
.rpicker-item:active              { transform: scale(0.985); }

.rpicker-item-text   { flex: 1; min-width: 0; }
.rpicker-item-name   { font-weight: 700; font-size: 15px; color: var(--text); line-height: 1.25; }
.rpicker-item-meta   { font-size: 12px; color: var(--text-muted); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.rpicker-item-check  { font-size: 18px; color: var(--brand); opacity: 0; transition: opacity 0.14s; flex-shrink: 0; margin-left: 14px; }
.rpicker-item.is-selected .rpicker-item-check { opacity: 1; }

/* footer */
.rpicker-footer { padding: 12px 16px 28px; flex-shrink: 0; border-top: 1px solid var(--border); }
.rpicker-cancel {
    display: flex; align-items: center; justify-content: center;
    width: 100%; padding: 14px; border-radius: var(--radius-sm);
    font-family: var(--font-display); font-size: 15px; font-weight: 800;
    text-transform: uppercase; letter-spacing: 0.5px;
    border: 1px solid var(--border); background: transparent; color: var(--text-dim);
    cursor: pointer; transition: all 0.18s;
}
.rpicker-cancel:hover { background: var(--surface-3); color: var(--text); }

.rpicker-hidden { display: none; }
</style>
{% endblock %}

{% block content %}

{% set today_name = today_name | default('') %}
{% set day_shorts = {'Monday':'MON','Tuesday':'TUE','Wednesday':'WED','Thursday':'THU','Friday':'FRI','Saturday':'SAT','Sunday':'SUN'} %}
{% set day_order  = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'] %}

{% set today_idx = namespace(value=-1) %}
{% for d in day_order %}{% if d == today_name %}{% set today_idx.value = loop.index0 %}{% endif %}{% endfor %}

<!-- Page header -->
<div class="page-header">
    <h1>âš¡ Schedule</h1>
    <p>Your weekly training plan â€” only today's workout is live.</p>
</div>

<!-- Week overview strip -->
<div class="week-strip">
    {% for day in all_days %}
    {% set short = day_shorts[day] %}
    <div class="week-day-chip">
        <span class="week-day-lbl">{{ short }}</span>
        {% if day in schedule %}
            {% set st = schedule[day].status if 'status' in schedule[day] else 'not_started' %}
            <div class="week-day-dot has-routine {% if st=='completed' %}is-done{% endif %} {% if day==today_name %}is-today{% endif %}">
                {% if st=='completed' %}âœ“{% else %}{{ short[0] }}{% endif %}
            </div>
        {% else %}
            <div class="week-day-dot {% if day==today_name %}is-today{% endif %}">â€“</div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Day cards -->
{% for day in all_days %}
{% set is_today  = (day == today_name) %}
{% set loop_idx  = loop.index0 %}
{% set is_past   = (today_idx.value > -1 and loop_idx < today_idx.value) %}
{% set is_future = (today_idx.value > -1 and loop_idx > today_idx.value) %}
{% set is_rest   = (day not in schedule and day not in availability) %}

<div class="day-card
    {% if is_today %}is-today{% elif is_past %}is-past{% elif is_future %}is-future{% endif %}
    {% if is_rest %}rest-only{% endif %}">

    <div class="day-header">
        <div class="day-header-left">
            <div class="day-name {% if is_today %}today-label{% endif %}">
                {{ day }}{% if is_today %} Â· <span style="font-size:14px;font-weight:700;letter-spacing:0;text-transform:none;">Today</span>{% endif %}
            </div>

            {% if day in schedule %}
                {% set st = schedule[day].status if 'status' in schedule[day] else 'not_started' %}
                {% if is_today %}
                    {% if st=='completed'   %}<span class="day-badge badge-done">âœ“ Done</span>
                    {% elif st=='in_progress' %}<span class="day-badge badge-progress">In Progress</span>
                    {% else %}<span class="day-badge badge-today">Today</span>{% endif %}
                {% else %}
                    {% if st=='completed' %}<span class="day-badge badge-done">âœ“ Done</span>
                    {% else %}<span class="day-badge badge-locked">ğŸ”’ Locked</span>{% endif %}
                {% endif %}
            {% elif day in availability %}
                <span class="day-badge badge-rest">No Routine</span>
            {% else %}
                <span class="day-badge badge-rest">Rest Day</span>
            {% endif %}
        </div>

        {% if day in schedule or day in availability %}
        <button class="btn-edit-day" title="Change routine"
                onclick="openPicker('schedule','{{ day }}',{{ schedule[day].routine_id if day in schedule else 'null' }})">âœï¸</button>
        {% endif %}
    </div>

    {% if day in schedule %}
        <div class="routine-name">{{ schedule[day].routine_name }}</div>
        <div class="routine-desc">{{ schedule[day].description or 'Ready to train.' }}</div>

        {% set st = schedule[day].status if 'status' in schedule[day] else 'not_started' %}
        {% if st=='completed' %}
            <a href="{{ url_for('workout', routine_id=schedule[day].routine_id) }}" class="btn-day btn-day-done">âœ“ Completed</a>
        {% elif st=='in_progress' and is_today %}
            <a href="{{ url_for('workout', routine_id=schedule[day].routine_id) }}" class="btn-day btn-day-continue">â–¶ Continue â†’</a>
        {% elif is_today %}
            <a href="{{ url_for('workout', routine_id=schedule[day].routine_id) }}" class="btn-day btn-day-start">âš¡ Start Workout</a>
        {% else %}
            <button class="btn-day btn-day-locked" disabled>ğŸ”’ Available on {{ day }}</button>
        {% endif %}

    {% elif day in availability %}
        <div class="no-routine-text">You're available to train â€” no routine assigned yet.</div>
        <button class="btn-add-routine" onclick="openPicker('schedule','{{ day }}',null)">ï¼‹ Assign Routine</button>

    {% else %}
        <div class="rest-text">Rest & recover. Your body grows when it rests.</div>
    {% endif %}

</div>
{% endfor %}

<!-- Extra Workout section -->
<div class="extra-workout-section">
    <div class="extra-workout-header">
        <span class="extra-workout-icon">ğŸ”¥</span>
        <span class="extra-workout-title">Extra Workout</span>
    </div>
    <p class="extra-workout-sub">
        Showing up on a rest day? Want to go beyond your plan?
        Pick any routine and crush it â€” every rep counts toward your EXP.
    </p>

    <div class="extra-workout-actions">
        <button class="btn-extra-pick" onclick="openPicker('extra',null,null)">
            <span id="extra-picker-label">Choose Routine</span>
            <span class="btn-extra-pick-icon">ï¼‹</span>
        </button>
        <a id="extra-start-btn" href="#" class="btn-extra-start">ğŸ”¥ Let's Go â†’</a>
    </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SHARED ROUTINE PICKER MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="rpicker-overlay" id="rpicker-overlay" onclick="overlayClick(event)">
    <div class="rpicker-sheet">
        <div class="rpicker-pill"></div>

        <div class="rpicker-header">
            <div>
                <div class="rpicker-title"    id="rpicker-title">Select Routine</div>
                <div class="rpicker-subtitle" id="rpicker-subtitle">Choose an alternative</div>
            </div>
            <button class="rpicker-close" onclick="closePicker()">âœ•</button>
        </div>

        <div class="rpicker-list" id="rpicker-list"></div>

        <div class="rpicker-footer">
            <button class="rpicker-cancel" onclick="closePicker()">CANCEL</button>
        </div>
    </div>
</div>

<!-- Hidden form for schedule updates -->
<form id="schedule-assign-form" method="POST" action="{{ url_for('client_update_schedule') }}" class="rpicker-hidden">
    <input type="hidden" name="day"        id="saf-day">
    <input type="hidden" name="routine_id" id="saf-rid">
</form>

<!-- Routine data injected for JS -->
<script id="routines-data" type="application/json">
[{% if all_routines %}{% for r in all_routines %}{"id":{{ r.routine_id }},"name":{{ r.routine_name|tojson }},"desc":{{ (r.description or '')|tojson }},"url":"{{ url_for('workout', routine_id=r.routine_id) }}"}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}]
</script>

{% endblock %}

{% block extra_js %}
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTINE PICKER  Â·  LevelUP Gym
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const ROUTINES = JSON.parse(document.getElementById('routines-data').textContent || '[]');

let _mode     = null;   // 'schedule' | 'extra'
let _day      = null;
let _selected = null;   // currently selected routine id (int)

const overlay    = document.getElementById('rpicker-overlay');
const listEl     = document.getElementById('rpicker-list');
const titleEl    = document.getElementById('rpicker-title');
const subtitleEl = document.getElementById('rpicker-subtitle');

/* â”€â”€ Open modal â”€â”€ */
function openPicker(mode, day, currentId) {
    _mode     = mode;
    _day      = day;
    _selected = currentId != null ? parseInt(currentId) : null;

    if (mode === 'schedule' && day) {
        titleEl.textContent    = day in ['Monday'] ? 'Change Routine' : 'Change Routine';
        titleEl.textContent    = 'Change Routine';
        subtitleEl.textContent = `Choose a routine for ${day}`;
    } else {
        titleEl.textContent    = 'Extra Workout';
        subtitleEl.textContent = 'Choose any routine to start now';
    }

    buildList();
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';
}

/* â”€â”€ Close modal â”€â”€ */
function closePicker() {
    overlay.classList.remove('open');
    document.body.style.overflow = '';
}

/* â”€â”€ Close when tapping backdrop â”€â”€ */
function overlayClick(e) {
    if (e.target === overlay) closePicker();
}

/* â”€â”€ Build the list â”€â”€ */
function buildList() {
    if (!ROUTINES.length) {
        listEl.innerHTML = '<p style="text-align:center;color:var(--text-dim);padding:32px 0 24px;">No routines available.</p>';
        return;
    }
    listEl.innerHTML = ROUTINES.map(r => {
        const sel  = (_selected === r.id) ? 'is-selected' : '';
        const desc = r.desc
            ? `<div class="rpicker-item-meta">${escHtml(r.desc)}</div>`
            : '';
        return `<div class="rpicker-item ${sel}"
                     data-id="${r.id}"
                     data-url="${escHtml(r.url)}"
                     data-name="${escHtml(r.name)}"
                     onclick="pick(${r.id}, this)">
                    <div class="rpicker-item-text">
                        <div class="rpicker-item-name">${escHtml(r.name)}</div>
                        ${desc}
                    </div>
                    <div class="rpicker-item-check">âœ“</div>
                </div>`;
    }).join('');
}

/* â”€â”€ User selects a routine â”€â”€ */
function pick(id, el) {
    _selected = id;

    /* Highlight the tapped row, clear all others */
    listEl.querySelectorAll('.rpicker-item').forEach(row => row.classList.remove('is-selected'));
    el.classList.add('is-selected');

    const url  = el.dataset.url;
    const name = el.dataset.name;

    /* Tactile pause then commit & close */
    setTimeout(() => {
        closePicker();

        if (_mode === 'schedule') {
            document.getElementById('saf-day').value = _day;
            document.getElementById('saf-rid').value = id;
            document.getElementById('schedule-assign-form').submit();
        } else {
            const btn   = document.getElementById('extra-start-btn');
            const label = document.getElementById('extra-picker-label');
            if (btn)   { btn.href = url; btn.classList.add('active'); }
            if (label) { label.textContent = name; label.classList.add('chosen'); }
        }
    }, 180);
}

/* â”€â”€ Escape key â”€â”€ */
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePicker(); });

/* â”€â”€ Helper: escape HTML â”€â”€ */
function escHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
{% endblock %}