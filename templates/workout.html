{% extends "base.html" %}

{% block title %}Workout - {{ routine.routine_name }}{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       OVERRIDE BASE - Full screen workout mode
    ============================================ */
    body {
        background: #0d0f14 !important;
        overflow: hidden;
    }

    .top-nav, .bottom-nav {
        display: none !important;
    }

    .container {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    /* ============================================
       DESIGN TOKENS
    ============================================ */
    :root {
        --brand: #7c5cfc;
        --brand-glow: rgba(124, 92, 252, 0.4);
        --green: #00e5a0;
        --green-glow: rgba(0, 229, 160, 0.35);
        --amber: #ffb020;
        --red: #ff4757;
        --surface: #161a24;
        --surface-2: #1e2330;
        --surface-3: #252b3b;
        --border: rgba(255,255,255,0.08);
        --text: #f0f2f8;
        --text-muted: #7a84a0;
        --text-dim: #4a5168;
        --radius: 16px;
        --font-display: 'Barlow Condensed', sans-serif;
        --font-body: 'DM Sans', sans-serif;
    }

    @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=DM+Sans:wght@400;500;600&display=swap');

    * { box-sizing: border-box; }

    /* ============================================
       LAYOUT SHELL
    ============================================ */
    #workout-shell {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
        background: #0d0f14;
        font-family: var(--font-body);
        color: var(--text);
    }

    /* ============================================
       HEADER
    ============================================ */
    #workout-header {
        flex-shrink: 0;
        padding: 14px 20px 10px;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        z-index: 10;
    }

    .header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .header-back {
        background: var(--surface-3);
        border: 1px solid var(--border);
        color: var(--text-muted);
        width: 36px; height: 36px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        font-size: 18px;
        transition: all 0.2s;
        text-decoration: none;
    }

    .header-back:hover { color: var(--text); background: var(--surface-2); }

    .header-title {
        font-family: var(--font-display);
        font-size: 16px;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: var(--text);
        text-align: center;
        flex: 1;
        padding: 0 10px;
    }

    .header-exp {
        background: linear-gradient(135deg, #ffb020, #ff8c00);
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
        font-family: var(--font-display);
        letter-spacing: 0.5px;
    }

    /* Progress bar */
    .progress-track {
        background: var(--surface-3);
        height: 6px;
        border-radius: 99px;
        overflow: hidden;
        position: relative;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--brand), var(--green));
        border-radius: 99px;
        transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 0 8px var(--green-glow);
    }

    .progress-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 11px;
        color: var(--text-muted);
        font-weight: 500;
    }

    /* ============================================
       EXERCISE NAVIGATION DOTS
    ============================================ */
    #exercise-nav {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 12px 20px;
        overflow-x: auto;
        scrollbar-width: none;
    }
    #exercise-nav::-webkit-scrollbar { display: none; }

    .ex-dot {
        flex-shrink: 0;
        height: 6px;
        border-radius: 99px;
        transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        cursor: pointer;
    }
    .ex-dot.done { width: 14px; background: var(--green); opacity: 0.7; }
    .ex-dot.active { width: 28px; background: var(--brand); box-shadow: 0 0 8px var(--brand-glow); }
    .ex-dot.upcoming { width: 6px; background: var(--surface-3); border: 1px solid var(--border); }

    /* ============================================
       MAIN EXERCISE AREA
    ============================================ */
    #exercise-stage {
        flex: 1;
        overflow: hidden;
        position: relative;
    }

    /* Slide container */
    .exercise-slides {
        display: flex;
        width: 100%;
        height: 100%;
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .exercise-slide {
        flex-shrink: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        scrollbar-width: none;
        padding: 16px 20px 120px;
    }
    .exercise-slide::-webkit-scrollbar { display: none; }

    /* Exercise name + meta */
    .ex-label {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: var(--brand);
        margin-bottom: 4px;
        font-family: var(--font-display);
    }

    .ex-name {
        font-family: var(--font-display);
        font-size: 38px;
        font-weight: 800;
        line-height: 1;
        color: var(--text);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .ex-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }

    .ex-tag {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 99px;
        background: var(--surface-3);
        color: var(--text-muted);
        border: 1px solid var(--border);
    }

    .ex-tag.muscle { color: var(--brand); border-color: var(--brand-glow); background: rgba(124,92,252,0.12); }
    .ex-tag.exp { color: var(--amber); border-color: rgba(255,176,32,0.3); background: rgba(255,176,32,0.1); }

    /* Inline swap button (sits next to view/hide) */
    .btn-swap-inline {
        flex-shrink: 0;
        background: var(--surface-3);
        border: 1px solid var(--border);
        color: var(--text-muted);
        width: 36px; height: 36px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
    }
    .btn-swap-inline:hover { background: rgba(255,183,32,0.12); border-color: rgba(255,183,32,0.4); }

    /* Image toggle button */
    .btn-view-image {
        flex-shrink: 0;
        background: var(--surface-3);
        border: 1px solid var(--border);
        color: var(--text-muted);
        padding: 8px 14px;
        border-radius: 10px;
        font-family: var(--font-body);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        margin-top: 6px;
    }
    .btn-view-image:hover { background: var(--surface-2); color: var(--text); }
    .btn-view-image.open { background: rgba(124,92,252,0.15); border-color: var(--brand); color: var(--brand); }

    /* Collapsible image container */
    .ex-image-collapse {
        display: none;
        overflow: hidden;
        margin-bottom: 14px;
        animation: slideDown 0.25s ease-out;
    }
    .ex-image-collapse.open { display: block; }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-8px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    /* Exercise image (inside collapsible) */
    .ex-image-wrap {
        position: relative;
        border-radius: var(--radius);
        overflow: hidden;
        background: var(--surface-2);
        margin-bottom: 10px;
        aspect-ratio: 16/7;
        border: 1px solid var(--border);
    }

    .ex-image-wrap img {
        width: 100%; height: 100%;
        object-fit: cover;
        opacity: 0.85;
    }

    /* Target info */
    .target-info {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .target-pill {
        flex: 1;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
    }

    .target-pill-value {
        font-family: var(--font-display);
        font-size: 28px;
        font-weight: 800;
        color: var(--text);
        line-height: 1;
    }

    .target-pill-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 3px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    /* ============================================
       SETS AREA
    ============================================ */
    .sets-label {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: var(--text-muted);
        margin-bottom: 10px;
        font-family: var(--font-display);
    }

    .sets-track {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
    }

    .set-pip {
        flex: 1;
        height: 8px;
        border-radius: 99px;
        background: var(--surface-3);
        border: 1px solid var(--border);
        transition: all 0.3s;
        cursor: default;
    }
    .set-pip.done { background: var(--green); border-color: var(--green); box-shadow: 0 0 6px var(--green-glow); }
    .set-pip.active { background: var(--brand); border-color: var(--brand); box-shadow: 0 0 6px var(--brand-glow); animation: pulse-pip 1.5s ease-in-out infinite; }

    @keyframes pulse-pip {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* SET INPUT CARD */
    .set-card {
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s;
        display: none; /* hidden by default */
    }

    .set-card.active {
        display: block; /* only active set is shown */
        border-color: var(--brand);
        box-shadow: 0 0 0 1px var(--brand-glow), 0 8px 32px rgba(124,92,252,0.2);
    }

    .set-card.done {
        display: none; /* completed sets are also hidden */
    }

    .set-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 14px;
    }

    .set-number {
        font-family: var(--font-display);
        font-size: 20px;
        font-weight: 800;
        color: var(--text);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .set-status-done {
        font-size: 12px;
        font-weight: 700;
        color: var(--green);
        background: rgba(0,229,160,0.12);
        border: 1px solid rgba(0,229,160,0.25);
        padding: 4px 10px;
        border-radius: 99px;
        display: flex; align-items: center; gap: 4px;
    }

    .set-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .set-input-wrap {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .set-input-wrap label {
        font-size: 11px;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.8px;
    }

    .set-input-wrap input {
        background: var(--surface-3);
        border: 1.5px solid var(--border);
        color: var(--text);
        border-radius: 10px;
        padding: 12px 14px;
        font-size: 20px;
        font-weight: 600;
        font-family: var(--font-display);
        width: 100%;
        text-align: center;
        transition: all 0.2s;
        -webkit-appearance: none;
    }

    .set-input-wrap input:focus {
        outline: none;
        border-color: var(--brand);
        background: rgba(124,92,252,0.1);
    }

    .set-input-wrap input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ============================================
       BOTTOM ACTION BAR
    ============================================ */
    #action-bar {
        position: fixed;
        bottom: 0; left: 0; right: 0;
        padding: 16px 20px 28px;
        background: linear-gradient(to top, #0d0f14 60%, transparent);
        z-index: 20;
    }

    .btn-log-set {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, var(--brand), #5e3fde);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        font-family: var(--font-display);
        font-size: 22px;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 8px 32px rgba(124,92,252,0.4);
        position: relative;
        overflow: hidden;
    }

    .btn-log-set:active {
        transform: scale(0.97);
        box-shadow: 0 4px 16px rgba(124,92,252,0.3);
    }

    .btn-log-set:disabled {
        background: var(--surface-3);
        color: var(--text-dim);
        box-shadow: none;
        cursor: not-allowed;
    }

    .btn-next-exercise {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, var(--green), #00c97d);
        color: #0d1a12;
        border: none;
        border-radius: var(--radius);
        font-family: var(--font-display);
        font-size: 22px;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 8px 32px var(--green-glow);
        display: none;
    }

    .btn-next-exercise:active { transform: scale(0.97); }

    .btn-finish-workout {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, var(--amber), #e67e00);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        font-family: var(--font-display);
        font-size: 22px;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 8px 32px rgba(255,176,32,0.35);
        display: none;
    }

    .btn-finish-workout:active { transform: scale(0.97); }

    /* ============================================
       REST TIMER OVERLAY
    ============================================ */
    #rest-overlay {
        position: fixed;
        inset: 0;
        background: rgba(13,15,20,0.92);
        backdrop-filter: blur(12px);
        z-index: 100;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px;
    }

    #rest-overlay.active { display: flex; }

    .rest-label {
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--text-muted);
        margin-bottom: 8px;
        font-family: var(--font-display);
    }

    .rest-circle {
        position: relative;
        width: 200px; height: 200px;
        margin: 20px auto;
    }

    .rest-circle svg {
        transform: rotate(-90deg);
    }

    .rest-circle-bg {
        fill: none;
        stroke: var(--surface-3);
        stroke-width: 6;
    }

    .rest-circle-progress {
        fill: none;
        stroke: var(--green);
        stroke-width: 6;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s linear;
        filter: drop-shadow(0 0 6px var(--green-glow));
    }

    .rest-time-display {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .rest-seconds {
        font-family: var(--font-display);
        font-size: 64px;
        font-weight: 800;
        color: var(--text);
        line-height: 1;
    }

    .rest-unit {
        font-size: 14px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    .rest-message {
        font-family: var(--font-display);
        font-size: 22px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 10px;
    }

    .rest-next-hint {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 28px;
    }

    .btn-skip-rest {
        background: var(--surface-3);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 14px 32px;
        border-radius: var(--radius);
        font-family: var(--font-display);
        font-size: 16px;
        font-weight: 700;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-skip-rest:hover { background: var(--surface-2); }

    /* ============================================
       EXP ANIMATION
    ============================================ */
    .exp-pop {
        position: fixed;
        font-family: var(--font-display);
        font-size: 28px;
        font-weight: 800;
        color: var(--amber);
        text-shadow: 0 0 20px rgba(255,176,32,0.8);
        pointer-events: none;
        z-index: 9999;
        animation: expPop 1.4s ease-out forwards;
    }

    @keyframes expPop {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        20% { opacity: 1; transform: translate(-50%, -80%) scale(1.2); }
        80% { opacity: 1; transform: translate(-50%, -150%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -180%) scale(0.9); }
    }

    /* ============================================
       MODALS
    ============================================ */
    .workout-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(10px);
        z-index: 200;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    .workout-modal.active { display: flex; }

    .workout-modal-content {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 28px;
        width: 100%;
        max-width: 420px;
        text-align: center;
        position: relative;
        box-shadow: 0 25px 80px rgba(0,0,0,0.5);
    }

    .modal-close {
        position: absolute;
        top: 14px; right: 14px;
        background: var(--surface-3);
        border: 1px solid var(--border);
        color: var(--text-muted);
        width: 30px; height: 30px;
        border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }

    .modal-close:hover { color: var(--text); }

    .modal-title {
        font-family: var(--font-display);
        font-size: 26px;
        font-weight: 800;
        color: var(--text);
        margin-bottom: 10px;
        text-transform: uppercase;
    }

    .modal-img {
        width: 100%;
        border-radius: 12px;
        margin: 14px 0;
        max-height: 220px;
        object-fit: cover;
    }

    /* Level Up Modal */
    .levelup-emoji {
        font-size: 72px;
        display: block;
        animation: levelBounce 0.8s ease-out;
    }

    @keyframes levelBounce {
        0% { transform: scale(0); }
        60% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .levelup-new {
        font-family: var(--font-display);
        font-size: 64px;
        font-weight: 800;
        background: linear-gradient(135deg, var(--amber), #ff6b00);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
    }

    .btn-modal {
        margin-top: 16px;
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        border: none;
        font-family: var(--font-display);
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-modal-brand { background: linear-gradient(135deg, var(--brand), #5e3fde); color: #fff; }

    /* Swap modal */
    .swap-option {
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        margin-top: 10px;
        cursor: pointer;
        text-align: left;
        width: 100%;
        color: var(--text);
        font-family: var(--font-body);
        font-size: 14px;
        transition: all 0.2s;
    }
    .swap-option:hover { border-color: var(--brand); background: rgba(124,92,252,0.1); }

    /* Workout complete banner */
    #complete-banner {
        display: none;
        background: linear-gradient(135deg, rgba(0,229,160,0.15), rgba(0,229,160,0.05));
        border: 1px solid rgba(0,229,160,0.3);
        border-radius: var(--radius);
        padding: 20px;
        text-align: center;
        margin-bottom: 16px;
    }
    #complete-banner.visible { display: block; }
    .complete-title {
        font-family: var(--font-display);
        font-size: 28px;
        font-weight: 800;
        color: var(--green);
        text-transform: uppercase;
    }
    .complete-sub { color: var(--text-muted); font-size: 14px; margin-top: 4px; }

    /* Recommendation box */
    .rec-box {
        display: none;
        background: rgba(59, 130, 246, 0.12);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 10px;
        padding: 12px 14px;
        margin-top: 10px;
        font-size: 13px;
        color: #93c5fd;
    }
    .rec-box.visible { display: block; }

    /* Workout already done state */
    .session-done-overlay {
        background: rgba(0,229,160,0.06);
        border: 1px solid rgba(0,229,160,0.2);
        border-radius: 10px;
        padding: 12px 14px;
        text-align: center;
        font-size: 13px;
        color: var(--green);
        font-weight: 600;
        margin-bottom: 16px;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- ====================================================
     WORKOUT SHELL
===================================================== -->
<div id="workout-shell">

    <!-- HEADER -->
    <div id="workout-header">
        <div class="header-top">
            <a href="{{ url_for('schedule') }}" class="header-back">‚Üê</a>
            <div class="header-title">{{ routine.routine_name }}</div>
            <div class="header-exp" id="total-exp-display">0 EXP</div>
        </div>
        <div class="progress-track">
            <div class="progress-fill" id="progress-bar" style="width: {{ progress.completion_percentage }}%"></div>
        </div>
        <div class="progress-labels">
            <span id="progress-text">{{ progress.completed_sets }} / {{ progress.total_sets }} sets</span>
            <span id="progress-pct">{{ "%.0f"|format(progress.completion_percentage) }}%</span>
        </div>
    </div>

    <!-- EXERCISE NAVIGATION DOTS -->
    <div id="exercise-nav">
        {% for exercise in exercises %}
        <div class="ex-dot {% if loop.first %}active{% else %}upcoming{% endif %}" 
             id="dot-{{ loop.index0 }}"
             onclick="goToExercise({{ loop.index0 }})"></div>
        {% endfor %}
    </div>

    <!-- EXERCISE STAGE (sliding area) -->
    <div id="exercise-stage">
        <div class="exercise-slides" id="slides-container">

            {% for exercise in exercises %}
            {% set ex_idx = loop.index0 %}
            <div class="exercise-slide" id="slide-{{ ex_idx }}">

                <!-- Completed session notice -->
                {% if session_info.status == 'completed' %}
                <div id="complete-banner" class="visible" style="display:block;">
                    <div class="complete-title">üéâ Workout Done!</div>
                    <div class="complete-sub">Great work on {{ routine.routine_name }}</div>
                </div>
                {% endif %}

                <!-- Exercise header -->
                <div class="ex-label">Exercise {{ loop.index }} of {{ exercises|length }}</div>
                <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div class="ex-name" style="margin-bottom:0; flex:1;">{{ exercise.name }}</div>
                    <div style="display:flex; gap:8px; flex-shrink:0; margin-top:6px;">
                        <button class="btn-swap-inline"
                                onclick="openSwapModal({{ exercise.exercise_id }},'{{ exercise.target_muscle }}','{{ exercise.exercise_type }}', '{{ routine.rotuine_id }}', '{{ client_id }}')">
                            üîÑ
                        </button>
                        {% if exercise.image_path %}
                        <button class="btn-view-image open"
                                onclick="toggleExerciseImage({{ ex_idx }})"
                                id="img-btn-{{ ex_idx }}">
                            ‚úï Hide
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Collapsible image (open by default) -->
                {% if exercise.image_path %}
                <div class="ex-image-collapse open" id="img-collapse-{{ ex_idx }}">
                    <div class="ex-image-wrap">
                        <img src="{{ url_for('static', filename=exercise.image_path) }}" alt="{{ exercise.name }}">
                    </div>
                    <p style="color:var(--text-muted); font-size:13px; margin-bottom:12px; line-height:1.5;">{{ exercise.description }}</p>
                </div>
                {% endif %}

                <div class="ex-meta">
                    <span class="ex-tag muscle">{{ exercise.target_muscle }}</span>
                    <span class="ex-tag">{{ exercise.exercise_type.title() }}</span>
                    <span class="ex-tag exp">‚ö° {{ exercise.base_exp }} EXP/set</span>
                </div>

                <!-- Target info pills -->
                <div class="target-info">
                    <div class="target-pill">
                        <div class="target-pill-value">{{ exercise.sets }}</div>
                        <div class="target-pill-label">Sets</div>
                    </div>
                    <div class="target-pill">
                        <div class="target-pill-value">{{ exercise.reps }}</div>
                        <div class="target-pill-label">{{ 'Seconds' if exercise.measurement == 'seconds' else 'Reps' }}</div>
                    </div>
                    <div class="target-pill">
                        <div class="target-pill-value">{{ exercise.rest_seconds }}s</div>
                        <div class="target-pill-label">Rest</div>
                    </div>
                </div>

                <!-- Sets -->
                <div class="sets-label">Sets Progress</div>
                <div class="sets-track" id="track-{{ exercise.exercise_id }}">
                    {% for set_num in range(1, exercise.sets + 1) %}
                    {% set set_key = exercise.exercise_id|string + '-' + set_num|string %}
                    <div class="set-pip {% if set_key in progress.completion_map %}done{% elif loop.first %}active{% else %}upcoming{% endif %}" 
                         id="pip-{{ exercise.exercise_id }}-{{ set_num }}"></div>
                    {% endfor %}
                </div>

                <!-- Individual set cards -->
                <div id="sets-{{ exercise.exercise_id }}">
                    {% for set_num in range(1, exercise.sets + 1) %}
                    {% set set_key = exercise.exercise_id|string + '-' + set_num|string %}
                    {% set is_completed = set_key in progress.completion_map %}
                    
                    <div class="set-card {% if is_completed %}done{% elif loop.first %}active{% endif %}" 
                         id="setcard-{{ exercise.exercise_id }}-{{ set_num }}"
                         data-exercise="{{ exercise.exercise_id }}"
                         data-set="{{ set_num }}"
                         data-measurement="{{ exercise.measurement }}"
                         data-rest="{{ exercise.rest_seconds }}">
                        
                        <div class="set-card-header">
                            <span class="set-number">Set {{ set_num }}</span>
                            {% if is_completed %}
                            <span class="set-status-done">‚úì Logged</span>
                            {% endif %}
                        </div>

                        <div class="set-inputs">
                            <div class="set-input-wrap">
                                <label>{{ 'Seconds' if exercise.measurement == 'seconds' else 'Reps' }}</label>
                                <input type="number" 
                                       class="reps-input"
                                       placeholder="{{ exercise.reps }}"
                                       value="{% if is_completed %}{{ progress.completion_map[set_key].reps }}{% endif %}"
                                       {% if is_completed %}disabled{% endif %}
                                       inputmode="numeric">
                            </div>
                            {% if exercise.measurement != 'seconds' %}
                            <div class="set-input-wrap">
                                <label>Weight (kg)</label>
                                <input type="number" 
                                       class="weight-input"
                                       placeholder="0"
                                       step="0.5"
                                       value="{% if is_completed %}{{ progress.completion_map[set_key].weight }}{% else %}{{ exercise.weight }}{% endif %}"
                                       {% if is_completed %}disabled{% endif %}
                                       inputmode="decimal">
                            </div>
                            {% else %}
                            <input type="hidden" class="weight-input" value="0">
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Recommendation box -->
                <div class="rec-box" id="rec-{{ exercise.exercise_id }}"></div>

            </div>
            {% endfor %}

        </div><!-- /slides-container -->
    </div><!-- /exercise-stage -->

    <!-- ACTION BAR -->
    <div id="action-bar">
        <button class="btn-log-set" id="btn-log" onclick="logCurrentSet()">
            ‚úì Log Set
        </button>
        <button class="btn-next-exercise" id="btn-next" onclick="goToNextExercise()">
            Next Exercise ‚Üí
        </button>
        <button class="btn-finish-workout" id="btn-finish" onclick="finishWorkout()">
            üèÅ Finish Workout
        </button>
    </div>

</div><!-- /workout-shell -->


<!-- ====================================================
     REST TIMER OVERLAY
===================================================== -->
<div id="rest-overlay">
    <div class="rest-label">Rest Time</div>
    <div class="rest-circle">
        <svg width="200" height="200" viewBox="0 0 200 200">
            <circle class="rest-circle-bg" cx="100" cy="100" r="88"/>
            <circle class="rest-circle-progress" id="rest-ring" cx="100" cy="100" r="88"
                    stroke-dasharray="553"
                    stroke-dashoffset="0"/>
        </svg>
        <div class="rest-time-display">
            <span class="rest-seconds" id="rest-count">0</span>
            <span class="rest-unit">sec</span>
        </div>
    </div>
    <div class="rest-message" id="rest-msg" style="display:none;"></div>
    <div class="rest-next-hint" id="rest-next-hint">Get ready for the next set</div>
    <button class="btn-skip-rest" onclick="skipRest()">Skip Rest ‚Üí</button>
</div>


<!-- ====================================================
     MODALS
===================================================== -->

<!-- Level Up -->
<div class="workout-modal" id="levelUpModal">
    <div class="workout-modal-content">
        <span class="levelup-emoji">‚ö°</span>
        <div class="modal-title" style="margin-top:10px;">Level Up!</div>
        <div style="color:var(--text-muted); margin-bottom:10px; font-size:14px;">You reached</div>
        <div class="levelup-new">LVL <span id="newLevel">?</span></div>
        <button class="btn-modal btn-modal-brand" onclick="closeLevelUp()">Keep Grinding!</button>
    </div>
</div>

<!-- Exercise modal removed ‚Äî image now toggles inline next to exercise name -->

<!-- Swap Modal -->
<div class="workout-modal" id="swapModal">
    <div class="workout-modal-content">
        <div class="modal-close" onclick="closeSwapModal()">‚úï</div>
        <div class="modal-title">Swap Exercise</div>
        <p style="color:var(--text-muted); font-size:13px; margin-bottom:6px;">Choose an alternative:</p>
        <div id="swap-options-list"></div>
        <button class="btn-modal" onclick="closeSwapModal()" style="background:var(--surface-3); color:var(--text); margin-top:16px;">Cancel</button>
    </div>
</div>

<!-- ====================================================
     HIDDEN DATA (for JS)
===================================================== -->
<script>
    // Serialize exercise data for JS
    const EXERCISES = [
        {% for exercise in exercises %}
        {
            exerciseId: {{ exercise.exercise_id }},
            name: "{{ exercise.name }}",
            sets: {{ exercise.sets }},
            reps: {{ exercise.reps }},
            restSeconds: {{ exercise.rest_seconds }},
            measurement: "{{ exercise.measurement }}",
            baseExp: {{ exercise.base_exp }},
            index: {{ loop.index0 }},
        },
        {% endfor %}
    ];

    const SESSION_STATUS = "{{ session_info.status }}";
    const CLIENT_ID = "{{ client_id }}";
    const ROUTINE_ID = "{{ routine.rotuine_id }}";
    const TOTAL_SETS = {{ progress.total_sets }};
    const INITIAL_COMPLETED = {{ progress.completed_sets }};

    // Build initial completion map from server
    const INITIAL_COMPLETION_MAP = {
        {% for key, val in progress.completion_map.items() %}
        "{{ key }}": true,
        {% endfor %}
    };
</script>

<script>
// ============================================================
//  STATE
// ============================================================
let currentExIndex = 0;
let totalExpEarned = 0;
let restTimerInterval = null;
let restSecondsLeft = 0;
let restTotalSeconds = 0;
let swapCurrentExerciseId = null;

// Track which set is "active" per exercise
const activeSetMap = {};
EXERCISES.forEach(ex => {
    // Find first uncompleted set
    let firstUncompleted = null;
    for (let s = 1; s <= ex.sets; s++) {
        const key = `${ex.exerciseId}-${s}`;
        if (!INITIAL_COMPLETION_MAP[key]) {
            firstUncompleted = s;
            break;
        }
    }
    activeSetMap[ex.exerciseId] = firstUncompleted; // null = all done
});

// ============================================================
//  INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    // Jump to first incomplete exercise
    let firstIncomplete = 0;
    for (let i = 0; i < EXERCISES.length; i++) {
        if (activeSetMap[EXERCISES[i].exerciseId] !== null) {
            firstIncomplete = i;
            break;
        }
        if (i === EXERCISES.length - 1) firstIncomplete = i; // all done
    }
    goToExercise(firstIncomplete);
    
    if (SESSION_STATUS === 'completed') {
        updateActionBarButtons(true);
    }
});

// ============================================================
//  NAVIGATION
// ============================================================
function goToExercise(idx) {
    if (idx < 0 || idx >= EXERCISES.length) return;
    currentExIndex = idx;

    // Slide
    const container = document.getElementById('slides-container');
    container.style.transform = `translateX(-${idx * 100}%)`;

    // Update dots
    EXERCISES.forEach((ex, i) => {
        const dot = document.getElementById(`dot-${i}`);
        if (!dot) return;
        dot.className = 'ex-dot';
        if (i === idx) dot.classList.add('active');
        else if (activeSetMap[ex.exerciseId] === null) dot.classList.add('done');
        else dot.classList.add('upcoming');
    });

    // Update action bar
    updateActionBarButtons();

    // Scroll slide to top
    const slide = document.getElementById(`slide-${idx}`);
    if (slide) slide.scrollTop = 0;
}

function goToNextExercise() {
    if (currentExIndex < EXERCISES.length - 1) {
        goToExercise(currentExIndex + 1);
    }
}

// ============================================================
//  LOG SET
// ============================================================
async function logCurrentSet() {
    const ex = EXERCISES[currentExIndex];
    const activeSet = activeSetMap[ex.exerciseId];
    if (!activeSet) return;

    const card = document.getElementById(`setcard-${ex.exerciseId}-${activeSet}`);
    if (!card) return;

    const repsInput = card.querySelector('.reps-input');
    const weightInput = card.querySelector('.weight-input');
    const reps = parseFloat(repsInput.value);
    const weight = parseFloat(weightInput.value) || 0;
    const measurement = card.dataset.measurement;

    // Validate reps
    if (!repsInput.value.trim() || isNaN(reps) || reps <= 0) {
        repsInput.style.borderColor = 'var(--red)';
        repsInput.style.background = 'rgba(255,71,87,0.1)';
        repsInput.placeholder = '‚ö† Enter a value';
        repsInput.focus();
        setTimeout(() => {
            repsInput.style.borderColor = '';
            repsInput.style.background = '';
            repsInput.placeholder = ex.reps;
        }, 2000);
        return;
    }

    // Disable log button while logging
    const logBtn = document.getElementById('btn-log');
    logBtn.disabled = true;
    logBtn.textContent = '‚è≥ Logging...';

    try {
        const response = await fetch('/log_set', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exercise_id: ex.exerciseId,
                set_number: activeSet,
                reps, weight, measurement
            })
        });

        const result = await response.json();

        if (result.success) {
            markSetDone(ex.exerciseId, activeSet, result);
            totalExpEarned += result.exp_earned;
            updateExpDisplay();
            showExpAnimation(result.exp_earned);
            updateProgressBar();

            if (result.recommendation) {
                // Show recommendation inside the rest timer overlay
                const restMsg = document.getElementById('rest-msg');
                restMsg.textContent = result.recommendation.message;
                restMsg.style.display = 'block';
            } else {
                document.getElementById('rest-msg').style.display = 'none';
            }

            if (result.level_info?.leveled_up) {
                document.getElementById('newLevel').textContent = result.level_info.new_level;
                document.getElementById('levelUpModal').classList.add('active');
            }

            // Advance active set
            advanceSet(ex.exerciseId, activeSet, ex.sets);

            // Start rest timer
            startRestTimer(ex.restSeconds, ex.exerciseId);
        }

    } catch (err) {
        console.error(err);
        logBtn.disabled = false;
        logBtn.textContent = '‚úì Log Set';
        alert('Failed to log set. Please try again.');
    }
}

function markSetDone(exerciseId, setNum, result) {
    const card = document.getElementById(`setcard-${exerciseId}-${setNum}`);
    if (!card) return;
    card.classList.remove('active');
    card.classList.add('done');

    // Add "Logged" badge
    const header = card.querySelector('.set-card-header');
    if (header && !header.querySelector('.set-status-done')) {
        const badge = document.createElement('span');
        badge.className = 'set-status-done';
        badge.textContent = '‚úì Logged';
        header.appendChild(badge);
    }

    // Disable inputs
    card.querySelectorAll('input').forEach(i => i.disabled = true);

    // Update pip
    const pip = document.getElementById(`pip-${exerciseId}-${setNum}`);
    if (pip) { pip.className = 'set-pip done'; }
}

function advanceSet(exerciseId, justLogged, totalSets) {
    const nextSet = justLogged + 1;
    if (nextSet <= totalSets) {
        activeSetMap[exerciseId] = nextSet;
        const nextCard = document.getElementById(`setcard-${exerciseId}-${nextSet}`);
        if (nextCard) nextCard.classList.add('active');
        const pip = document.getElementById(`pip-${exerciseId}-${nextSet}`);
        if (pip) pip.className = 'set-pip active';
    } else {
        activeSetMap[exerciseId] = null; // all done
    }
    updateActionBarButtons();
}

// ============================================================
//  ACTION BAR STATE
// ============================================================
function updateActionBarButtons(forceComplete = false) {
    const logBtn = document.getElementById('btn-log');
    const nextBtn = document.getElementById('btn-next');
    const finishBtn = document.getElementById('btn-finish');

    const ex = EXERCISES[currentExIndex];
    const activeSet = activeSetMap[ex.exerciseId];
    const isLastExercise = currentExIndex === EXERCISES.length - 1;
    const allDone = EXERCISES.every(e => activeSetMap[e.exerciseId] === null);

    logBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    finishBtn.style.display = 'none';

    if (forceComplete || SESSION_STATUS === 'completed') {
        finishBtn.style.display = 'block';
        finishBtn.textContent = 'üè† Back to Schedule';
        finishBtn.onclick = () => window.location.href = '/schedule';
        return;
    }

    if (activeSet !== null) {
        // There are sets to log on current exercise
        logBtn.style.display = 'block';
        logBtn.disabled = false;
        logBtn.textContent = `‚úì Log Set ${activeSet}`;
    } else if (!isLastExercise) {
        // Current exercise done, not last
        nextBtn.style.display = 'block';
    } else if (allDone) {
        // All done!
        finishBtn.style.display = 'block';
    } else {
        // Last exercise, current ex done, but others incomplete
        finishBtn.style.display = 'block';
    }
}

// ============================================================
//  REST TIMER
// ============================================================
function startRestTimer(seconds, exerciseId) {
    if (!seconds || seconds <= 0) {
        afterRestCallback(exerciseId);
        return;
    }

    clearInterval(restTimerInterval);
    restSecondsLeft = seconds;
    restTotalSeconds = seconds;

    const overlay = document.getElementById('rest-overlay');
    const countEl = document.getElementById('rest-count');
    const ring = document.getElementById('rest-ring');
    const circumference = 553;

    // Update next hint
    const ex = EXERCISES[currentExIndex];
    const nextSet = activeSetMap[ex.exerciseId];
    const hintEl = document.getElementById('rest-next-hint');
    if (nextSet) {
        hintEl.textContent = `Next: Set ${nextSet} of ${ex.sets}`;
    } else if (currentExIndex < EXERCISES.length - 1) {
        hintEl.textContent = `Next: ${EXERCISES[currentExIndex + 1].name}`;
    } else {
        hintEl.textContent = 'Almost done! Last set complete üéâ';
    }

    overlay.classList.add('active');
    countEl.textContent = restSecondsLeft;
    ring.style.strokeDashoffset = 0;

    restTimerInterval = setInterval(() => {
        restSecondsLeft--;
        countEl.textContent = restSecondsLeft;
        const progress = 1 - (restSecondsLeft / restTotalSeconds);
        ring.style.strokeDashoffset = circumference * progress;

        if (restSecondsLeft <= 0) {
            skipRest(exerciseId);
        }
    }, 1000);
}

function skipRest(exerciseId) {
    clearInterval(restTimerInterval);
    document.getElementById('rest-overlay').classList.remove('active');
    document.getElementById('rest-msg').style.display = 'none';
    afterRestCallback(exerciseId);
}

function afterRestCallback(exerciseId) {
    // Scroll to active set card
    const ex = EXERCISES[currentExIndex];
    const nextSet = activeSetMap[ex.exerciseId];
    if (nextSet) {
        const card = document.getElementById(`setcard-${ex.exerciseId}-${nextSet}`);
        if (card) setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }
}

// ============================================================
//  PROGRESS BAR
// ============================================================
function updateProgressBar() {
    const allSets = document.querySelectorAll('.set-card');
    const doneSets = document.querySelectorAll('.set-card.done');
    const total = allSets.length;
    const done = doneSets.length;
    const pct = total > 0 ? (done / total) * 100 : 0;

    const bar = document.getElementById('progress-bar');
    const txt = document.getElementById('progress-text');
    const pctEl = document.getElementById('progress-pct');

    if (bar) bar.style.width = `${pct}%`;
    if (txt) txt.textContent = `${done} / ${total} sets`;
    if (pctEl) pctEl.textContent = `${Math.round(pct)}%`;

    updateActionBarButtons();
}

function updateExpDisplay() {
    const el = document.getElementById('total-exp-display');
    if (el) el.textContent = `${totalExpEarned} EXP`;
}

// ============================================================
//  FINISH WORKOUT
// ============================================================
async function finishWorkout() {
    const btn = document.getElementById('btn-finish');
    btn.disabled = true;
    btn.textContent = '‚è≥ Finishing...';

    const allSets = document.querySelectorAll('.set-card');
    const doneSets = document.querySelectorAll('.set-card.done');

    if (doneSets.length < allSets.length) {
        const confirm = window.confirm('Not all sets are logged. Finish anyway?');
        if (!confirm) { btn.disabled = false; btn.textContent = 'üèÅ Finish Workout'; return; }
    }

    try {
        const response = await fetch('/finish_workout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ client_id: CLIENT_ID })
        });
        const result = await response.json();
        if (result.success) {
            window.location.href = result.redirect_url || '/schedule';
        }
    } catch (err) {
        console.error(err);
        btn.disabled = false;
        btn.textContent = 'üèÅ Finish Workout';
        alert('Error finishing workout. Please try again.');
    }
}

// ============================================================
//  EXP ANIMATION
// ============================================================
function showExpAnimation(amount) {
    const el = document.createElement('div');
    el.className = 'exp-pop';
    el.textContent = `+${amount} EXP`;
    el.style.left = '50%';
    el.style.top = '40%';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1500);
}

// ============================================================
//  IMAGE TOGGLE (inline collapsible)
// ============================================================
function toggleExerciseImage(idx) {
    const collapse = document.getElementById(`img-collapse-${idx}`);
    const btn = document.getElementById(`img-btn-${idx}`);
    if (!collapse) return;

    const isOpen = collapse.classList.contains('open');
    collapse.classList.toggle('open', !isOpen);
    btn.classList.toggle('open', !isOpen);
    btn.textContent = isOpen ? 'üëÅ View' : '‚úï Hide';
}

function closeLevelUp() {
    document.getElementById('levelUpModal').classList.remove('active');
}

// ============================================================
//  SWAP MODAL
// ============================================================
function openSwapModal(exerciseId, targetMuscle, exerciseType, routineId, clientId) {
    swapCurrentExerciseId = exerciseId;
    const list = document.getElementById('swap-options-list');
    list.innerHTML = '<div style="color:var(--text-muted); font-size:13px; text-align:center; padding:16px;">Loading alternatives...</div>';
    document.getElementById('swapModal').classList.add('active');

    fetch(`/get_swap_options?exercise_id=${exerciseId}&target_muscle=${encodeURIComponent(targetMuscle)}&exercise_type=${encodeURIComponent(exerciseType)}&routine_id=${routineId}&client_id=${clientId}`)
        .then(r => r.json())
        .then(data => {
            if (data.options && data.options.length > 0) {
                list.innerHTML = data.options.map(opt => `
                    <button class="swap-option" onclick="confirmSwap(${exerciseId}, ${opt.exercise_id}, '${routineId}', '${clientId}')">
                        <strong>${opt.name}</strong><br>
                        <span style="color:var(--text-muted); font-size:12px;">${opt.target_muscle} ¬∑ ${opt.exercise_type}</span>
                    </button>
                `).join('');
            } else {
                list.innerHTML = '<div style="color:var(--text-muted); font-size:13px; text-align:center; padding:16px;">No alternatives available</div>';
            }
        })
        .catch(() => {
            list.innerHTML = '<div style="color:var(--red); font-size:13px; text-align:center; padding:16px;">Failed to load options</div>';
        });
}

function closeSwapModal() {
    document.getElementById('swapModal').classList.remove('active');
}

async function confirmSwap(oldExId, newExId, routineId, clientId) {
    try {
        const response = await fetch('/swap_exercise', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ old_exercise_id: oldExId, new_exercise_id: newExId, routine_id: routineId, client_id: clientId })
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert(result.message || 'Swap failed');
        }
    } catch (err) {
        alert('Error performing swap');
    }
}
</script>

{% endblock %}